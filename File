<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bike Configurator (HTML Only)</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --text:#101218;
      --muted:#5b6475;
      --accent:#1f4bff;
      --ok:#1f9d67;
      --bad:#d64550;
      --border:rgba(16,18,24,.12);
      --shadow: 0 12px 30px rgba(15,23,42,.12);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1680px;
      margin: 0 auto;
      padding: 28px 18px 40px;
      display:grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.2fr) minmax(260px, 0.9fr);
      gap: 18px;
    }
    header{
      grid-column: 1 / -1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    .title{display:flex; flex-direction:column; gap:6px}
    h1{margin:0; font-size: 22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; line-height:1.4}

    .top-actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button{
      appearance:none; border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      box-shadow: 0 6px 16px rgba(15,23,42,.08);
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{border-color: rgba(31,75,255,.35)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(31,75,255,.35);
      background: rgba(31,75,255,.08);
    }
    button.success{
      border-color: rgba(31,157,103,.35);
      background: rgba(31,157,103,.10);
    }
    button.danger{
      border-color: rgba(214,69,80,.35);
      background: rgba(214,69,80,.08);
    }

    .panel{
      background: #fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hd .h2{font-weight: 800; font-size: 14px; letter-spacing:.2px}
    .panel .bd{padding: 14px}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      .grid{grid-template-columns:1fr}
    }

    .step{
      border:1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      overflow:hidden;
    }
    .step .shd{
      padding: 10px 10px 8px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
    }
    .pill{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(31,75,255,.12);
      border:1px solid rgba(31,75,255,.25);
      color: #1f2d6a;
    }
    .pill.ok{
      background: rgba(31,157,103,.12);
      border-color: rgba(31,157,103,.25);
      color:#0f5b3c;
    }
    .step .shd .name{font-weight: 800; font-size: 12px}
    .step .shd .meta{font-size:11px; color: var(--muted)}
    .step .sbd{padding: 10px}

    .options-panel .bd{
      padding: 12px;
      max-height: calc(100vh - 190px);
      overflow-y: auto;
    }

    .summary-panel .bd{
      padding: 0;
    }
    .summary-sticky{
      position: sticky;
      top: 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .accordion-toolbar{
      display:flex;
      justify-content:flex-end;
      margin-bottom: 8px;
      font-size:12px;
    }
    .accordion-toolbar button{
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      box-shadow:none;
    }
    .accordion-section{
      border:1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .accordion-header{
      width:100%;
      border:0;
      padding: 10px 12px;
      background: #fafbff;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      text-align:left;
      font-weight:700;
      box-shadow:none;
    }
    .accordion-header:hover{background:#f4f6ff}
    .accordion-index{
      width:28px;
      height:28px;
      border-radius:999px;
      background: rgba(31,75,255,.12);
      border:1px solid rgba(31,75,255,.25);
      color:#1f2d6a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:800;
      flex:0 0 auto;
    }
    .accordion-index.ok{
      background: rgba(31,157,103,.12);
      border-color: rgba(31,157,103,.25);
      color:#0f5b3c;
    }
    .accordion-meta{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .accordion-meta .name{
      font-size:12px;
      font-weight:800;
    }
    .accordion-meta .sub{
      font-size:11px;
      color:var(--muted);
    }
    .accordion-actions{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
    }
    .required-badge{
      background: rgba(214,69,80,.12);
      color:#91202a;
      border:1px solid rgba(214,69,80,.25);
      padding: 4px 6px;
      border-radius: 999px;
      font-weight:800;
      font-size:10px;
    }
    .accordion-chevron{
      font-size:16px;
      color:var(--muted);
      transition: transform .2s ease;
    }
    .accordion-section[data-open="true"] .accordion-chevron{transform: rotate(180deg);}
    .accordion-body{
      display:none;
      padding: 12px;
      border-top:1px solid var(--border);
      background: #fff;
    }
    .accordion-section[data-open="true"] .accordion-body{display:block;}
    .options-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:10px;
    }
    .option-card{
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding: 8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      min-height: 140px;
      position:relative;
      font-weight:700;
      font-size:12px;
      box-shadow: 0 4px 12px rgba(15,23,42,.06);
      transition: border .2s ease, transform .1s ease;
    }
    .option-card:hover{border-color: rgba(31,75,255,.35);}
    .option-card.selected{
      border-color: rgba(31,75,255,.8);
      box-shadow: 0 0 0 2px rgba(31,75,255,.15);
    }
    .option-card.locked{
      cursor:not-allowed;
      opacity:.75;
    }
    .option-thumb{
      display:block;
      width:100%;
    }
    .option-thumb-viewport{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 10px;
      height: 96px;
      overflow:hidden;
      position:relative;
    }
    .option-thumb-viewport img{
      position:absolute;
      left:50%;
      top:50%;
      width:100%;
      height:100%;
      object-fit:contain;
      transform-origin:center;
      display:block;
    }
    .option-title{
      font-size:12px;
      color:var(--text);
      min-height: 28px;
    }
    .price-badge{
      align-self:flex-start;
      background: rgba(31,75,255,.12);
      color:#1f2d6a;
      border-radius: 999px;
      padding: 3px 8px;
      font-size:10px;
      font-weight:800;
      border:1px solid rgba(31,75,255,.2);
    }
    .price-badge.hidden{display:none;}
    .option-check{
      position:absolute;
      top:8px;
      right:8px;
      background: rgba(31,75,255,.9);
      color:#fff;
      width:20px;
      height:20px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:800;
      opacity:0;
      transform: scale(.9);
      transition: opacity .2s ease, transform .2s ease;
    }
    .option-card.selected .option-check{
      opacity:1;
      transform: scale(1);
    }
    .option-lock{
      position:absolute;
      top:8px;
      left:8px;
      background: rgba(16,18,24,.08);
      color: var(--muted);
      font-size:10px;
      font-weight:800;
      padding: 2px 6px;
      border-radius: 999px;
      border:1px solid var(--border);
    }
    .next-group{
      margin-top:12px;
      width:100%;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .next-group button{
      padding: 6px 10px;
      font-size:12px;
    }

    @media (max-width: 980px){
      .options-panel .bd{
        max-height: unset;
      }
      .summary-sticky{
        position: static;
      }
    }

    label{
      display:flex;
      flex-direction:column;
      gap:4px;
      width:100%;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
    }
    select, input[type="number"], textarea, input[type="text"], input[type="password"]{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
      outline:none;
      font-weight:700;
    }
    select:disabled, input:disabled, textarea:disabled{
      background: #f0f2f6;
      color: #7c8597;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(31,75,255,.5);
      box-shadow: 0 0 0 3px rgba(31,75,255,.12);
    }

    .summary{display:flex; flex-direction:column; gap:10px}
    .totals{
      display:flex; flex-direction:column; gap:8px;
      padding: 10px 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .line{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 13px}
    .line strong{font-size: 14px}
    .hr{height:1px; background: var(--border); margin:6px 0}
    .items{
      padding: 10px 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .items ul{margin:0; padding-left: 18px}
    .items li{margin:6px 0; color:#1d2435}
    .muted{color:var(--muted)}
    .sku-card{
      padding: 10px 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sku-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sku-label{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .sku-value{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      letter-spacing: .08em;
      color: #1d2435;
      word-break: break-all;
    }
    .sku-status{
      font-size: 12px;
      color: var(--muted);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:800;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      width: fit-content;
    }
    .dot{width:10px; height:10px; border-radius: 999px; background: rgba(16,18,24,.3)}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 13px;
      display:none;
      max-width: 420px;
      z-index: 999;
      white-space: pre-wrap;
    }

    .composite-card{
      padding: 14px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .composite-preview{
      position: relative;
      width: 100%;
      max-width: none;
      aspect-ratio: 16 / 9;
      min-height: clamp(260px, 32vw, 520px);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 0 auto;
    }
    .composite-preview img{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      image-rendering: auto;
    }
    .composite-empty{
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      padding: 12px;
    }
    .composite-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .composite-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:700;
      color: var(--muted);
    }
    .composite-toggle input{
      width:auto;
    }
    .composite-actions button{
      margin-left:auto;
    }

    .preview-panel .bd{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .summary-block{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .summary-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .summary-header .h2{font-weight:800; font-size:14px}

    .options-panel{
      display:flex;
      flex-direction:column;
    }
    .options-panel .step{border-radius: 12px}
    .options-panel .pill{font-size: 11px; padding: 4px 8px}

    @media (max-width: 980px){
      .options-panel .bd{
        max-height: none;
      }
      .summary-sticky{
        position: static;
      }
    }

    .admin-overlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
    }
    .admin-modal{
      background:#fff;
      border-radius: 16px;
      padding: 18px;
      width: min(420px, 90vw);
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    .admin-modal h3{margin:0 0 10px; font-size:16px}
    .admin-panel{
      position: fixed;
      inset: auto 12px 12px 12px;
      background:#fff;
      border-radius: 16px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      max-height: 80vh;
      display:none;
      flex-direction:column;
      z-index: 998;
    }
    .admin-panel .admin-header{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: #f9faff;
      flex-wrap:wrap;
    }
    .admin-panel .admin-body{
      padding: 14px;
      overflow:auto;
      display:grid;
      gap: 12px;
    }
    .admin-actions{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs button{padding:6px 10px; font-size:12px}
    .admin-tabs button.active{border-color: rgba(31,75,255,.6); background: rgba(31,75,255,.12)}
    .admin-section{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #fafbff;
    }
    .admin-table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .admin-table th,
    .admin-table td{
      border-bottom:1px solid var(--border);
      padding: 6px;
      text-align:left;
      vertical-align:top;
    }
    .admin-table th{color: var(--muted); font-weight:700}
    .admin-row-actions{display:flex; gap:6px; flex-wrap:wrap}
    .admin-row-actions button{padding:6px 8px; font-size:11px}
    .status-line{font-size:12px; color: var(--muted)}
    .status-line.warn{color: var(--bad); font-weight: 800}
    .admin-group-row{
      display:grid;
      grid-template-columns: 120px 1fr 110px 1fr;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .admin-inline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .admin-inline label{flex:1}
    .admin-inline .small{max-width: 180px}
    .admin-inline input[type="checkbox"]{width:auto}
    .admin-help{font-size:12px; color: var(--muted)}
    .combo-layer-card{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .combo-layer-header{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .combo-layer-fields{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:8px;
      align-items:end;
    }
    .combo-layer-fields input[type="checkbox"]{width:auto}
    .combo-layer-map{
      border:1px dashed var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #f8f9fd;
    }
    .combo-layer-map table{width:100%; border-collapse:collapse; font-size:12px}
    .combo-layer-map th,
    .combo-layer-map td{
      border-bottom:1px solid var(--border);
      padding:6px;
      text-align:left;
    }
    .combo-layer-map th{color: var(--muted); font-weight:700}
    .sku-cell{display:flex; flex-direction:column; gap:6px}
    .sku-summary{font-size:11px; color: var(--muted)}
    .sku-editor{
      display:none;
      padding: 8px;
      border:1px dashed var(--border);
      border-radius: 10px;
      background: #f8f9fd;
    }
    .sku-editor.open{display:block}
    .sku-entry{
      display:flex;
      gap:8px;
      align-items:flex-end;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .sku-entry input[type="number"]{max-width:90px}
    .sku-entry input[type="text"]{min-width:120px}
    .crop-controls{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .crop-row{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:6px;
    }
    .crop-row label{font-size:11px}
    .crop-row input{width:100%}
    .crop-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .crop-actions button{
      padding:4px 6px;
      font-size:11px;
    }
    .crop-preview{
      height: 78px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 10px;
      overflow:hidden;
      position:relative;
      cursor: crosshair;
    }
    .crop-preview img{
      position:absolute;
      left:50%;
      top:50%;
      width:100%;
      height:100%;
      object-fit:contain;
      transform-origin:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Bike Configurator</h1>
        <div class="sub">
          HTML-only. Click <b>Order</b> to add Product <b>#114</b> to cart and return to home.
        </div>
      </div>

      <div class="top-actions">
        <button id="btnAdmin" class="primary">ADMIN</button>
        <button id="btnReset">Reset</button>
        <button id="btnCopyJson">Copy JSON</button>
        <button id="btnOrder" class="success">Order (Add to Cart)</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="panel preview-panel">
      <div class="hd">
        <div class="h2">Composite preview</div>
        <div class="muted" style="font-size:12px">
          Preview builds live as you select options.
        </div>
      </div>
      <div class="bd">
        <div class="composite-card">
          <div class="line">
            <strong>Composite preview</strong>
          </div>
          <div class="composite-preview" id="compositePreview">
            <div class="composite-empty" id="compositeEmpty">No images for current selections.</div>
          </div>
          <div class="composite-actions">
            <label class="composite-toggle">
              <input id="compositeWhiteBg" type="checkbox" checked>
              White background
            </label>
            <button id="btnDownloadComposite" class="primary">Download composite (1920×1080)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MIDDLE -->
    <aside class="panel options-panel">
      <div class="hd">
        <div class="h2">Build your bike</div>
        <div class="muted" style="font-size:12px">
          Adds to cart via Storefront Cart API.
        </div>
      </div>
      <div class="bd">
        <div class="accordion-list" id="stepsGrid"></div>
      </div>
    </aside>

    <!-- RIGHT -->
    <aside class="panel summary-panel">
      <div class="hd">
        <div class="h2">Summary</div>
        <div class="badge" id="validBadge">
          <span class="dot bad" id="validDot"></span>
          <span id="validText">Incomplete</span>
        </div>
      </div>
      <div class="bd">
        <div class="summary-sticky">
          <div class="summary-block">
            <div class="totals">
              <div class="line"><span>Base price</span><strong id="basePrice">—</strong></div>
              <div class="line"><span>Options</span><strong id="optionsPrice">—</strong></div>
              <div class="hr"></div>
              <div class="line"><span>Unit total</span><strong id="unitTotal">—</strong></div>
              <div class="line"><span>Quantity</span><strong id="qtyDisplay">—</strong></div>
              <div class="hr"></div>
              <div class="line"><span>Grand total</span><strong id="grandTotal">—</strong></div>
            </div>

            <div class="sku-card">
              <div class="sku-row">
                <span class="sku-label">SKU:</span>
                <span class="sku-value" id="skuValue">—</span>
              </div>
              <div class="sku-row">
                <span class="sku-status" id="skuStatus"></span>
                <button id="btnCopySku" class="primary">Copy SKU</button>
              </div>
            </div>
          </div>

          <div class="summary-block">
            <div class="items">
              <div class="line" style="margin-bottom:8px;">
                <strong>Selected</strong>
                <span class="muted">Product ID for cart: <b>114</b></span>
              </div>
              <ul id="selectionList"></ul>
              <div class="muted" id="constraintMsg" style="margin-top:10px; font-size:12px;"></div>
            </div>

            <div class="muted" style="font-size:12px; line-height:1.35">
              If “Order” fails with a message about missing option/variant, it means Product 114 needs a
              <b>variantId</b> or <b>optionSelections</b> to be added to cart.
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>
  <iframe name="hiddenCartFrame" style="display:none;"></iframe>

  <div class="admin-overlay" id="adminPrompt">
    <div class="admin-modal">
      <h3>Admin access</h3>
      <label>Password
        <input id="adminPassword" type="password" placeholder="Enter password" />
      </label>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <button id="adminCancel">Cancel</button>
        <button id="adminSubmit" class="primary">Enter</button>
      </div>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel">
    <div class="admin-header">
      <div>
        <strong>Admin Panel</strong>
        <div class="status-line" id="adminStatusLine"></div>
        <div class="status-line" id="adminSizeLine"></div>
      </div>
      <div class="admin-actions">
        <button id="btnRefreshSheet">Refresh from Sheet</button>
        <button id="btnResetSheet">Reset to Sheet</button>
        <button id="btnResetDefaults">Reset to Defaults</button>
        <button id="btnSaveSheet" class="success">Save to Sheet</button>
        <button id="btnExitAdmin" class="danger">Logout / Exit Admin</button>
      </div>
    </div>
    <div class="admin-body">
      <label>Model to edit
        <select id="adminModelSelect"></select>
      </label>
      <div class="admin-section" id="adminGroupsSection"></div>
      <div class="admin-section" id="adminOptionsSection"></div>
      <div class="admin-section" id="adminComboLayersSection"></div>
    </div>
  </div>

<script>
(function(){
  // =========================
  // BIGCOMMERCE SETTINGS
  // =========================
  const PRODUCT_ID = 114;

  // Your storefront home page (redirect after add-to-cart success)
  const HOME_URL = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/";

  // =========================
  // CONFIG API SETTINGS
  // =========================
  const CONFIG_API_BASE = "https://script.google.com/macros/s/AKfycbxXozAWB_L2XQhUEVOWd36XPdtqxhHPQbVHbcTzZvcznn6MS9igoZhigt6KBkTvG-0-Qg/exec";
  const CONFIG_API_KEY = "IwillUpdatethepaswordlater";
  const CONFIG_SIZE_WARNING = 200000;

  const DEFAULT_SKU_LENGTH = 30;
  const SKU_PLACEHOLDER = "_";

  // =========================
  // DEFAULT CONFIG (fallback)
  // =========================
  const DEFAULT_CONFIG = {
    version: 2,
    models: {
      "c-line": {
        label: "C Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "black", label: "Black", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "red", label: "Red", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "1", label: "1-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      },
      "c-line-elec": {
        label: "C Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "green", label: "Green", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      },
      "p-line": {
        label: "P Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "yellow", label: "Yellow", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "raw-lacquer", label: "Raw Lacquer", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "2", label: "2-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "8", label: "8-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      },
      "p-line-elec": {
        label: "P Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "line-green", label: "Line Green", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      },
      "g-line": {
        label: "G Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      },
      "g-line-elec": {
        label: "G Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true, layerPriority: 0 }
            ]
          }
        }
      }
    }
  };

  let CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));

  // =========================
  // STATE
  // =========================
  const STORAGE_KEY = "bike_configurator_b2b_v3";
  const ADMIN_STORAGE_KEY = "bike_configurator_admin_mode";
  const state = {
    modelId: "",
    selections: {},
    qty: 1,
    notes: "",
    openGroupKey: "",
    collapseAll: false
  };

  const adminState = {
    enabled: false,
    modelId: "",
    activeGroup: "",
    lastSheetUpdatedAt: "",
    lastSaveAttempt: "",
    copySourceModelId: "",
    copySourceGroupKey: "",
    copyTargetBehavior: "new",
    copyTargetGroupKey: "",
    skuEditor: null
  };

  const ADMIN_PASSWORD = "Brompton";

  // =========================
  // DOM
  // =========================
  const $ = (id) => document.getElementById(id);
  const els = {
    stepsGrid: $("stepsGrid"),

    basePrice: $("basePrice"),
    optionsPrice: $("optionsPrice"),
    unitTotal: $("unitTotal"),
    qtyDisplay: $("qtyDisplay"),
    grandTotal: $("grandTotal"),
    skuValue: $("skuValue"),
    skuStatus: $("skuStatus"),
    btnCopySku: $("btnCopySku"),

    selectionList: $("selectionList"),
    constraintMsg: $("constraintMsg"),
    compositePreview: $("compositePreview"),
    compositeEmpty: $("compositeEmpty"),
    compositeWhiteBg: $("compositeWhiteBg"),
    btnDownloadComposite: $("btnDownloadComposite"),

    validDot: $("validDot"),
    validText: $("validText"),

    btnReset: $("btnReset"),
    btnCopyJson: $("btnCopyJson"),
    btnOrder: $("btnOrder"),
    btnAdmin: $("btnAdmin"),

    toast: $("toast"),

    adminPrompt: $("adminPrompt"),
    adminPassword: $("adminPassword"),
    adminCancel: $("adminCancel"),
    adminSubmit: $("adminSubmit"),

    adminPanel: $("adminPanel"),
    adminModelSelect: $("adminModelSelect"),
    adminGroupsSection: $("adminGroupsSection"),
    adminOptionsSection: $("adminOptionsSection"),
    adminComboLayersSection: $("adminComboLayersSection"),
    adminStatusLine: $("adminStatusLine"),
    adminSizeLine: $("adminSizeLine"),
    btnRefreshSheet: $("btnRefreshSheet"),
    btnResetSheet: $("btnResetSheet"),
    btnResetDefaults: $("btnResetDefaults"),
    btnSaveSheet: $("btnSaveSheet"),
    btnExitAdmin: $("btnExitAdmin")
  };

  // =========================
  // HELPERS
  // =========================
  const ROUTE_MODEL_MAP = {
    "/c-line-configurator": "c-line",
    "/c-line-elec-configurator": "c-line-elec",
    "/g-line-configurator": "g-line",
    "/g-line-elec-configurator": "g-line-elec",
    "/p-line-configurator": "p-line",
    "/p-line-elec-configurator": "p-line-elec"
  };

  const DEFAULT_GROUP_ORDER = ["colors", "gearing", "rack", "lights"];
  const DEFAULT_IMAGE_CROP = { x: 0.5, y: 0.5, zoom: 1 };

  function getForcedModelFromPath(){
    const rawPath = (window.location.pathname || "").toLowerCase();
    const cleaned = rawPath.replace(/\/+$/, "") || "/";
    return ROUTE_MODEL_MAP[cleaned] || "";
  }

  let forcedModelId = getForcedModelFromPath();
  let routeError = forcedModelId
    ? ""
    : "This page URL does not match a valid configurator route. Please use a supported model URL.";

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> els.toast.style.display="none", 2600);
  }

  function money(n){
    const cur = "EUR";
    try{
      return new Intl.NumberFormat(undefined, { style:"currency", currency:cur, maximumFractionDigits:0 }).format(n);
    }catch(e){
      return cur + " " + Math.round(n);
    }
  }

  function normalizeQty(v){
    const n = Number(v);
    if (!Number.isFinite(n) || n < 1) return 1;
    return Math.floor(n);
  }

  function titleCaseFromKey(key){
    return String(key || "")
      .replace(/[_-]+/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b\w/g, (m) => m.toUpperCase());
  }

  function normalizeConfig(config){
    if (!config || !config.models) return config;
    Object.values(config.models).forEach((model) => {
      if (!model) return;
      if (model.options && !model.groups){
        const order = [];
        const groups = {};
        Object.entries(model.options).forEach(([key, options]) => {
          order.push(key);
          groups[key] = {
            label: titleCaseFromKey(key),
            required: true,
            options: Array.isArray(options) ? options : []
          };
        });
        model.groupsOrder = order.length ? order : DEFAULT_GROUP_ORDER.slice();
        model.groups = groups;
        delete model.options;
      }
      if (!Array.isArray(model.groupsOrder)){
        model.groupsOrder = model.groups ? Object.keys(model.groups) : DEFAULT_GROUP_ORDER.slice();
      }
      if (!model.groups){
        model.groups = {};
      }
      if (!Array.isArray(model.skuFixedDigits)){
        model.skuFixedDigits = [];
      }
      const skuLength = Number(model.skuLength);
      model.skuLength = Number.isFinite(skuLength) && skuLength > 0 ? Math.trunc(skuLength) : DEFAULT_SKU_LENGTH;
      if (!Array.isArray(model.comboLayers)){
        model.comboLayers = [];
      }
      model.groupsOrder.forEach((key) => {
        if (!model.groups[key]){
          model.groups[key] = {
            label: titleCaseFromKey(key),
            required: true,
            options: []
          };
        }else{
          if (!model.groups[key].label){
            model.groups[key].label = titleCaseFromKey(key);
          }
          if (typeof model.groups[key].required !== "boolean"){
            model.groups[key].required = true;
          }
          if (!Array.isArray(model.groups[key].options)){
            model.groups[key].options = [];
          }else{
            model.groups[key].options.forEach((option) => {
              const priority = Number(option.layerPriority);
              option.layerPriority = Number.isFinite(priority) ? Math.trunc(priority) : 0;
              if (!Array.isArray(option.skuDigits)){
                option.skuDigits = [];
              }
              option.imageCrop = normalizeImageCrop(option.imageCrop);
            });
          }
        }
      });
      model.comboLayers = model.comboLayers.map((layer, index) => {
        const normalized = layer && typeof layer === "object" ? layer : {};
        if (!normalized.id){
          normalized.id = `combo-${index + 1}`;
        }
        if (!normalized.label){
          normalized.label = titleCaseFromKey(normalized.id);
        }
        if (typeof normalized.enabled !== "boolean"){
          normalized.enabled = true;
        }
        const priority = Number(normalized.layerPriority);
        normalized.layerPriority = Number.isFinite(priority) ? Math.trunc(priority) : 0;
        if (!Array.isArray(normalized.dependsOn)){
          normalized.dependsOn = [];
        }
        if (!normalized.map || typeof normalized.map !== "object"){
          normalized.map = {};
        }
        return normalized;
      });
    });
    return config;
  }

  function clamp01(value){
    return Math.min(1, Math.max(0, value));
  }

  function normalizeImageCrop(crop){
    const raw = crop && typeof crop === "object" ? crop : {};
    const x = Number(raw.x);
    const y = Number(raw.y);
    const zoom = Number(raw.zoom);
    return {
      x: Number.isFinite(x) ? clamp01(x) : DEFAULT_IMAGE_CROP.x,
      y: Number.isFinite(y) ? clamp01(y) : DEFAULT_IMAGE_CROP.y,
      zoom: Number.isFinite(zoom) && zoom >= 1 ? zoom : DEFAULT_IMAGE_CROP.zoom
    };
  }

  function updateImageCrop(option, updates){
    if (!option) return DEFAULT_IMAGE_CROP;
    const next = normalizeImageCrop({ ...(option.imageCrop || {}), ...(updates || {}) });
    option.imageCrop = next;
    return next;
  }

  function getCropTransform(crop){
    const safe = normalizeImageCrop(crop);
    const translateX = (0.5 - safe.x) * 100;
    const translateY = (0.5 - safe.y) * 100;
    return `translate(${translateX}%, ${translateY}%) scale(${safe.zoom}) translate(-50%, -50%)`;
  }

  function deepClone(obj){
    return JSON.parse(JSON.stringify(obj));
  }

  function getSkuDigitsSummary(list){
    if (!Array.isArray(list) || list.length === 0) return "No entries";
    return `${list.length} ${list.length === 1 ? "entry" : "entries"}`;
  }

  function parseSkuIndex(value){
    const parsed = Number(value);
    if (!Number.isFinite(parsed)) return null;
    const intVal = Math.trunc(parsed);
    if (intVal < 1) return null;
    return intVal;
  }

  function validateSkuValue(value){
    return typeof value === "string" && value.trim().length > 0;
  }

  function getSkuLength(model){
    const length = Number(model?.skuLength);
    if (Number.isFinite(length) && length > 0){
      return Math.trunc(length);
    }
    return DEFAULT_SKU_LENGTH;
  }

  function applySkuDigits(buffer, digits){
    if (!Array.isArray(buffer) || !Array.isArray(digits)) return;
    digits.forEach((entry) => {
      if (!entry) return;
      const index = parseSkuIndex(entry.index);
      if (index === null || index > buffer.length) return;
      const value = String(entry.value ?? "").trim();
      if (!value) return;
      buffer[index - 1] = value;
    });
  }

  function buildSkuPreview(){
    const model = getModel(state.modelId);
    if (!model){
      return { sku: "", incomplete: true };
    }
    const skuLength = getSkuLength(model);
    const skuBuffer = Array.from({ length: skuLength }, () => SKU_PLACEHOLDER);
    applySkuDigits(skuBuffer, model.skuFixedDigits);
    (model.groupsOrder || []).forEach((groupKey) => {
      const selectedId = state.selections[groupKey];
      if (!selectedId) return;
      const option = findOption(model, groupKey, selectedId);
      if (!option) return;
      applySkuDigits(skuBuffer, option.skuDigits);
    });
    const sku = skuBuffer.join("");
    const incomplete = skuBuffer.includes(SKU_PLACEHOLDER);
    return { sku, incomplete };
  }

  function renderSkuPreview(){
    const data = buildSkuPreview();
    if (els.skuValue){
      els.skuValue.textContent = data.sku || "—";
    }
    if (els.skuStatus){
      els.skuStatus.textContent = data.incomplete ? "Incomplete SKU" : "";
    }
    const adminSkuValue = document.getElementById("adminSkuValue");
    const adminSkuStatus = document.getElementById("adminSkuStatus");
    if (adminSkuValue){
      adminSkuValue.textContent = data.sku || "—";
    }
    if (adminSkuStatus){
      adminSkuStatus.textContent = data.incomplete ? "Incomplete SKU" : "";
    }
  }

  async function copySkuToClipboard(){
    const data = buildSkuPreview();
    const text = data.sku || "";
    if (!text){
      toast("No SKU available to copy.");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      toast("SKU copied to clipboard.");
    }catch(err){
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      temp.remove();
      toast("SKU copied to clipboard.");
    }
  }

  function setSelectOptions(selectEl, list, placeholder){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    list.forEach(item=>{
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
      selectEl.appendChild(opt);
    });
  }

  function setSingleOption(selectEl, item){
    selectEl.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = item.id;
    opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
    selectEl.appendChild(opt);
  }

  function updatePill(pillEl, ok){
    pillEl.classList.toggle("ok", !!ok);
  }

  function metaWithFixed(label, fallback, selectEl){
    if (!label) return fallback;
    if (selectEl && selectEl.dataset.fixed === "true"){
      return `${label} (fixed for this model)`;
    }
    return label;
  }

  function getModel(modelId){
    return (CONFIG.models && CONFIG.models[modelId]) || null;
  }

  function getEnabledOptions(model, groupKey){
    if (!model || !model.groups || !model.groups[groupKey]) return [];
    const options = model.groups[groupKey].options || [];
    return options.filter(opt => opt.enabled);
  }

  function getCompositeGroupOrder(model){
    if (!model || !Array.isArray(model.groupsOrder)) return [];
    const order = model.groupsOrder.slice();
    if (order.includes("base")){
      return ["base", ...order.filter((key) => key !== "base")];
    }
    return order;
  }

  function getLayerPriority(option){
    const priority = Number(option && option.layerPriority);
    return Number.isFinite(priority) ? priority : 0;
  }

  function getComboLayers(model){
    return Array.isArray(model?.comboLayers) ? model.comboLayers : [];
  }

  function getComboLayerGroups(model, comboLayer){
    const dependsOn = Array.isArray(comboLayer?.dependsOn) ? comboLayer.dependsOn : [];
    const groupAKey = dependsOn[0] || "";
    const groupBKey = dependsOn[1] || "";
    const groupA = groupAKey ? model?.groups?.[groupAKey] : null;
    const groupB = groupBKey ? model?.groups?.[groupBKey] : null;
    const optionsA = groupA ? (Array.isArray(groupA.options) ? groupA.options : []) : [];
    const optionsB = groupB ? (Array.isArray(groupB.options) ? groupB.options : []) : [];
    return { groupAKey, groupBKey, groupA, groupB, optionsA, optionsB };
  }

  function getComboLayerCombinations(model, comboLayer){
    const { groupAKey, groupBKey, groupA, groupB, optionsA, optionsB } = getComboLayerGroups(model, comboLayer);
    if (!groupAKey || !groupBKey || !groupA || !groupB) return [];
    const combos = [];
    optionsA.forEach((optA) => {
      optionsB.forEach((optB) => {
        combos.push({
          key: `${optA.id}|${optB.id}`,
          optionA: optA,
          optionB: optB
        });
      });
    });
    return combos;
  }

  function getSelectedImageLayers(){
    const model = getModel(state.modelId);
    if (!model) return [];
    const order = getCompositeGroupOrder(model);
    const orderIndex = new Map();
    order.forEach((key, index) => orderIndex.set(key, index));
    const layers = [];
    order.forEach((groupKey) => {
      const group = model.groups[groupKey];
      if (!group) return;
      const selectedId = state.selections[groupKey] || "";
      if (!selectedId) return;
      const option = findOption(model, groupKey, selectedId);
      if (!option || !option.imageUrl) return;
      layers.push({
        groupKey,
        groupLabel: group.label || titleCaseFromKey(groupKey),
        optionId: option.id,
        optionLabel: option.label,
        imageUrl: option.imageUrl,
        layerPriority: getLayerPriority(option),
        orderIndex: orderIndex.get(groupKey) ?? 0,
        isCombo: false
      });
    });
    const comboLayers = getComboLayers(model);
    comboLayers.forEach((comboLayer) => {
      if (!comboLayer || comboLayer.enabled === false) return;
      const dependsOn = Array.isArray(comboLayer.dependsOn) ? comboLayer.dependsOn : [];
      if (dependsOn.length < 2) return;
      const selectedIds = dependsOn.map((groupKey) => state.selections[groupKey] || "");
      if (selectedIds.some((id) => !id)) return;
      const key = selectedIds.join("|");
      const imageUrl = comboLayer.map && comboLayer.map[key] ? comboLayer.map[key] : "";
      if (!imageUrl) return;
      layers.push({
        groupKey: comboLayer.id,
        groupLabel: comboLayer.label || titleCaseFromKey(comboLayer.id),
        optionId: key,
        optionLabel: key,
        imageUrl,
        layerPriority: getLayerPriority(comboLayer),
        orderIndex: order.length + layers.length,
        isCombo: true
      });
    });

    layers.sort((a, b) => {
      if (a.layerPriority !== b.layerPriority){
        return a.layerPriority - b.layerPriority;
      }
      if (!!a.isCombo !== !!b.isCombo){
        return a.isCombo ? 1 : -1;
      }
      if (a.orderIndex !== b.orderIndex){
        return a.orderIndex - b.orderIndex;
      }
      return String(a.groupKey || "").localeCompare(String(b.groupKey || ""));
    });
    return layers;
  }

  function renderComposite(layers){
    if (!els.compositePreview) return;
    els.compositePreview.innerHTML = "";
    const empty = !layers.length;
    if (empty){
      const placeholder = document.createElement("div");
      placeholder.className = "composite-empty";
      placeholder.textContent = "No images for current selections.";
      els.compositePreview.appendChild(placeholder);
      return;
    }
    layers.forEach((layer) => {
      const img = document.createElement("img");
      img.alt = `${layer.groupLabel}: ${layer.optionLabel}`;
      img.src = layer.imageUrl;
      els.compositePreview.appendChild(img);
    });
  }

  function drawContain(ctx, img, cw, ch){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.min(cw / iw, ch / ih);
    const drawW = iw * scale;
    const drawH = ih * scale;
    const drawX = (cw - drawW) / 2;
    const drawY = (ch - drawH) / 2;
    ctx.drawImage(img, drawX, drawY, drawW, drawH);
  }

  function loadLayerImage(url){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
      img.src = url;
    });
  }

  async function exportCompositePNG(layers, opts){
    if (!layers.length){
      toast("No layers to export.");
      return;
    }
    const width = 1920;
    const height = 1080;
    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    if (!ctx){
      toast("Canvas not supported in this browser.");
      return;
    }
    if (opts && opts.background === "white"){
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, width, height);
    }
    try{
      for (const layer of layers){
        const img = await loadLayerImage(layer.imageUrl);
        drawContain(ctx, img, width, height);
      }
      const blob = await new Promise((resolve, reject) => {
        canvas.toBlob((created) => {
          if (!created){
            reject(new Error("Canvas export failed"));
          }else{
            resolve(created);
          }
        }, "image/png");
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bike-composite.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }catch(err){
      console.error(err);
      toast("Cannot export composite because some images block cross-origin canvas. Ask to host images with CORS enabled.");
    }
  }

  function ensureSelection(model, groupKey, selection){
    const enabled = getEnabledOptions(model, groupKey);
    if (!enabled.length){
      return { value: "", fixed: true, enabled, selected: null, disabled: true };
    }
    const isFixed = enabled.length === 1;
    let nextValue = selection || "";
    if (isFixed){
      nextValue = enabled[0].id;
    }else if (nextValue && !enabled.some(opt => opt.id === nextValue)){
      nextValue = "";
    }
    const selected = enabled.find(opt => opt.id === nextValue) || null;
    return { value: nextValue, fixed: isFixed, enabled, selected, disabled: isFixed };
  }

  function buildOptionOptions(options, selectedValue, placeholder, allowEmpty){
    const parts = [];
    const placeholderLabel = placeholder || "Select option…";
    if (allowEmpty){
      parts.push(`<option value="">${escapeHtml(placeholderLabel)}</option>`);
    }
    options.forEach(opt => {
      const priceLabel = opt.price ? ` (+${money(opt.price)})` : "";
      const selected = opt.id === selectedValue ? "selected" : "";
      parts.push(`<option value="${escapeHtml(opt.id)}" ${selected}>${escapeHtml(opt.label)}${priceLabel}</option>`);
    });
    if (!allowEmpty && !options.length){
      parts.push(`<option value="">Unavailable</option>`);
    }
    return parts.join("");
  }

  function validateAndApplyConstraints(){
    if (routeError){
      state.modelId = "";
      state.selections = {};
      return { ok:false, msg:routeError, model:null, routeError:true, groups: [] };
    }

    const model = getModel(forcedModelId);
    if (!model){
      return { ok:false, msg:"Unsupported model route. Please use a valid configurator URL.", model:null, routeError:true, groups: [] };
    }

    state.modelId = forcedModelId;
    const groupKeys = model.groupsOrder || [];
    const groupStates = [];
    let changed = false;
    groupKeys.forEach((key) => {
      const group = model.groups[key] || { label: titleCaseFromKey(key), required: true, options: [] };
      const selection = state.selections[key] || "";
      const ensured = ensureSelection(model, key, selection);
      if (ensured.value !== selection){
        state.selections[key] = ensured.value;
        changed = true;
      }
      const required = group.required !== false;
      const isComplete = required ? !!ensured.value : true;
      groupStates.push({
        key,
        group,
        enabled: ensured.enabled,
        selectedId: ensured.value,
        selectedOption: ensured.selected,
        fixed: ensured.fixed,
        disabled: ensured.disabled,
        required,
        isComplete
      });
    });
    if (changed){
      saveState();
    }
    const missing = groupStates.filter(item => item.required && !item.selectedId)
      .map(item => item.group.label || titleCaseFromKey(item.key));
    if (missing.length){
      return { ok:false, msg:`Missing: ${missing.join(", ")}.`, model, groups: groupStates };
    }
    return { ok:true, msg:"Ready to order.", model, groups: groupStates };
  }

  function buildAttribute116Value(){
    const model = getModel(state.modelId);
    const missing = [];
    const parts = [];
    if (!model || !model.label){
      missing.push("Model");
    }else{
      parts.push(`Model: ${model.label}`);
    }
    if (model){
      (model.groupsOrder || []).forEach((key) => {
        const group = model.groups[key];
        if (!group) return;
        const selectedId = state.selections[key] || "";
        if (!selectedId){
          if (group.required !== false){
            missing.push(group.label || titleCaseFromKey(key));
          }
          return;
        }
        const option = findOption(model, key, selectedId);
        if (!option) return;
        const priceTag = option.price ? ` (+${money(option.price)})` : "";
        parts.push(`${group.label || titleCaseFromKey(key)}: ${option.label}${priceTag}`);
      });
    }

    if (missing.length){
      return { missing, value: "" };
    }
    const qtyValue = normalizeQty(state.qty);
    const notesValue = (state.notes || "").trim();
    parts.push(`Qty: ${qtyValue}`);
    parts.push(`Notes: ${notesValue || "(none)"}`);
    return { missing, value: parts.join("\n") };
  }

  function findOption(model, groupKey, id){
    if (!model || !model.groups || !model.groups[groupKey]) return null;
    return (model.groups[groupKey].options || []).find(opt => opt.id === id) || null;
  }

  function findOptionLabel(model, groupKey, id){
    const option = findOption(model, groupKey, id);
    return option ? option.label : "";
  }

  function calc(){
    const model = getModel(state.modelId);
    const base = 0;
    let optionsTotal = 0;
    if (model){
      (model.groupsOrder || []).forEach((key) => {
        const selectedId = state.selections[key];
        if (!selectedId) return;
        const option = findOption(model, key, selectedId);
        if (option && option.price){
          optionsTotal += option.price;
        }
      });
    }

    const unit = base + optionsTotal;
    const qty = normalizeQty(state.qty);
    const total = unit * qty;

    return { base, options: optionsTotal, unit, qty, total, model };
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj) return;
      state.modelId = obj.modelId || "";
      if (obj.selections && typeof obj.selections === "object"){
        state.selections = { ...obj.selections };
      }else{
        state.selections = {
          colors: obj.colorId || "",
          gearing: obj.gearingId || "",
          rack: obj.rackId || "",
          lights: obj.lightsId || ""
        };
      }
      state.qty = normalizeQty(obj.qty || 1);
      state.notes = obj.notes || "";
      state.openGroupKey = obj.openGroupKey || "";
      state.collapseAll = !!obj.collapseAll;
      if (forcedModelId){
        if (state.modelId !== forcedModelId){
          state.selections = {};
        }
        state.modelId = forcedModelId;
      }else{
        state.modelId = "";
        state.selections = {};
      }
    }catch(e){}
  }

  function loadAdminState(){
    try{
      const raw = localStorage.getItem(ADMIN_STORAGE_KEY);
      adminState.enabled = raw === "true";
    }catch(e){
      adminState.enabled = false;
    }
  }

  function saveAdminState(){
    try{
      localStorage.setItem(ADMIN_STORAGE_KEY, adminState.enabled ? "true" : "false");
    }catch(e){}
  }

  function exportConfig(){
    const exportPayload = {
      exportVersion: 1,
      timestamp: new Date().toISOString(),
      config: CONFIG,
      state: {
        modelId: state.modelId,
        selections: { ...state.selections },
        qty: state.qty,
        notes: state.notes,
        openGroupKey: state.openGroupKey,
        collapseAll: state.collapseAll
      }
    };
    return JSON.stringify(exportPayload, null, 2);
  }

  function getConfigSize(){
    try{
      return JSON.stringify(CONFIG).length;
    }catch(e){
      return 0;
    }
  }

  function updateAdminStatus(){
    const updatedAt = adminState.lastSheetUpdatedAt ? `Sheet updated: ${adminState.lastSheetUpdatedAt}` : "Sheet updated: —";
    const lastSave = adminState.lastSaveAttempt ? `Last save attempt: ${adminState.lastSaveAttempt}` : "Last save attempt: —";
    els.adminStatusLine.textContent = `${updatedAt} | ${lastSave}`;
    const size = getConfigSize();
    const warning = size > CONFIG_SIZE_WARNING;
    els.adminSizeLine.textContent = `Config size: ${size} chars${warning ? " (warning: large config)" : ""}`;
    els.adminSizeLine.classList.toggle("warn", warning);
  }

  function reconcileSelections(){
    let changed = false;
    const model = getModel(forcedModelId);
    if (!model){
      if (state.modelId || Object.keys(state.selections || {}).length){
        changed = true;
      }
      state.modelId = "";
      state.selections = {};
    }else{
      state.modelId = forcedModelId;
      const nextSelections = {};
      (model.groupsOrder || []).forEach((key) => {
        const enabledOptions = getEnabledOptions(model, key);
        const selectedId = state.selections[key] || "";
        if (selectedId && enabledOptions.some(opt => opt.id === selectedId)){
          nextSelections[key] = selectedId;
        }else if (enabledOptions.length === 1){
          nextSelections[key] = enabledOptions[0].id;
          if (state.selections[key] !== nextSelections[key]) changed = true;
        }else if (state.selections[key]){
          changed = true;
        }
      });
      const removedSelections = Object.keys(state.selections || {}).filter((key) => !(model.groupsOrder || []).includes(key));
      if (removedSelections.length){
        changed = true;
      }
      state.selections = nextSelections;
    }
    if (changed){
      saveState();
    }
  }

  async function fetchConfigFromSheet(){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    let responseText = "";
    const res = await fetch(url, {
      method: "GET",
      cache: "no-store",
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Config response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true || !json.data){
      const message = json && json.error ? json.error : "Config response missing ok/data.";
      const apiError = new Error(message);
      apiError.responseText = responseText;
      throw apiError;
    }
    adminState.lastSheetUpdatedAt = json.meta && json.meta.updated_at ? json.meta.updated_at : "";
    updateAdminStatus();
    return json.data;
  }

  async function saveConfigToSheet(configObj){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    const body = new URLSearchParams();
    body.set("payload", JSON.stringify(configObj));
    body.set("key", CONFIG_API_KEY);
    let responseText = "";
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString(),
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Save response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true){
      const message = json && json.error ? json.error : responseText;
      const apiError = new Error(message || "Save failed.");
      apiError.responseText = responseText;
      throw apiError;
    }
    return json;
  }

  async function loadConfigFromSheet(useFallbackOnError){
    try{
      CONFIG = normalizeConfig(await fetchConfigFromSheet());
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config loaded from sheet.");
      return true;
    }catch(err){
      console.error("Failed to load config from sheet.", err, err && err.responseText ? err.responseText : "");
      if (useFallbackOnError){
        CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));
        reconcileSelections();
        renderBuyer();
        renderAdmin();
        toast("Using local defaults (config API unavailable)");
      }else{
        const message = err && err.message ? err.message : "Unknown error";
        toast(`Failed to load sheet config: ${message}`);
      }
      return false;
    }
  }

  async function saveConfigFlow(){
    const errors = validateConfig(CONFIG);
    if (errors.length){
      toast("Fix validation errors before saving:\n" + errors.join("\n"));
      return false;
    }
    adminState.lastSaveAttempt = new Date().toLocaleString();
    updateAdminStatus();
    try{
      await saveConfigToSheet(CONFIG);
      toast("Saved to Sheet");
      renderBuyer();
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to save config to sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to save to Sheet: ${message}`);
      return false;
    }
  }

  function isValidImageUrl(value){
    return !value || /^https?:\/\//i.test(value);
  }

  function validateConfig(config){
    const errors = [];
    if (!config || !config.models){
      errors.push("Config models missing.");
      return errors;
    }
    Object.entries(config.models).forEach(([modelId, model]) => {
      if (!model.groups || !Array.isArray(model.groupsOrder)){
        errors.push(`${modelId} groups/groupsOrder missing.`);
        return;
      }
      const orderSet = new Set();
      model.groupsOrder.forEach((key) => {
        if (!/^[a-z0-9_-]+$/.test(key)){
          errors.push(`${modelId} group key "${key}" must be lowercase letters, numbers, dashes, or underscores.`);
        }
        if (orderSet.has(key)){
          errors.push(`${modelId} group key "${key}" appears multiple times in order.`);
        }
        orderSet.add(key);
        const group = model.groups[key];
        if (!group){
          errors.push(`${modelId} group "${key}" missing from groups.`);
          return;
        }
        if (!group.label){
          errors.push(`${modelId} group "${key}": label is required.`);
        }
        if (typeof group.required !== "boolean"){
          errors.push(`${modelId} group "${key}": required must be true/false.`);
        }
        const options = Array.isArray(group.options) ? group.options : [];
        const seen = new Set();
        options.forEach((opt, index) => {
          if (!opt.id){
            errors.push(`${modelId} ${group.label || key} option #${index + 1}: id is required.`);
          }else if (seen.has(opt.id)){
            errors.push(`${modelId} ${group.label || key} option id "${opt.id}" is duplicated.`);
          }else{
            seen.add(opt.id);
          }
          if (!isValidImageUrl(opt.imageUrl)){
            errors.push(`${modelId} ${group.label || key} option "${opt.id}": imageUrl must start with http:// or https://`);
          }
          const price = Number(opt.price);
          if (!Number.isFinite(price) || price < 0){
            errors.push(`${modelId} ${group.label || key} option "${opt.id}": price must be a number >= 0`);
          }
          const layerPriority = Number(opt.layerPriority);
          if (!Number.isFinite(layerPriority)){
            errors.push(`${modelId} ${group.label || key} option "${opt.id}": layerPriority must be a number`);
          }
        });
      });
      const comboLayers = Array.isArray(model.comboLayers) ? model.comboLayers : [];
      const comboIds = new Set();
      comboLayers.forEach((layer, index) => {
        if (!layer || typeof layer !== "object"){
          errors.push(`${modelId} combo layer #${index + 1}: layer definition must be an object.`);
          return;
        }
        if (!layer.id){
          errors.push(`${modelId} combo layer #${index + 1}: id is required.`);
        }else if (comboIds.has(layer.id)){
          errors.push(`${modelId} combo layer id "${layer.id}" is duplicated.`);
        }else{
          comboIds.add(layer.id);
        }
        if (!layer.label){
          errors.push(`${modelId} combo layer "${layer.id || index + 1}": label is required.`);
        }
        if (typeof layer.enabled !== "boolean"){
          errors.push(`${modelId} combo layer "${layer.id || index + 1}": enabled must be true/false.`);
        }
        const layerPriority = Number(layer.layerPriority);
        if (!Number.isFinite(layerPriority)){
          errors.push(`${modelId} combo layer "${layer.id || index + 1}": layerPriority must be a number.`);
        }
        const dependsOn = Array.isArray(layer.dependsOn) ? layer.dependsOn : [];
        if (dependsOn.length !== 2){
          errors.push(`${modelId} combo layer "${layer.id || index + 1}": dependsOn must list exactly 2 group keys.`);
        }else{
          if (dependsOn[0] === dependsOn[1]){
            errors.push(`${modelId} combo layer "${layer.id || index + 1}": dependsOn group keys must be unique.`);
          }
          dependsOn.forEach((groupKey) => {
            if (!model.groups || !model.groups[groupKey]){
              errors.push(`${modelId} combo layer "${layer.id || index + 1}": dependsOn group "${groupKey}" not found.`);
            }
          });
        }
        if (layer.map && typeof layer.map === "object"){
          Object.entries(layer.map).forEach(([key, value]) => {
            if (!isValidImageUrl(value)){
              errors.push(`${modelId} combo layer "${layer.id || index + 1}" map "${key}": imageUrl must start with http:// or https://`);
            }
          });
        }else if (layer.map !== undefined){
          errors.push(`${modelId} combo layer "${layer.id || index + 1}": map must be an object.`);
        }
      });
    });
    return errors;
  }

  function renderBuyer(){
    const v = validateAndApplyConstraints();
    const c = calc();

    els.constraintMsg.textContent = v.msg || "";

    els.basePrice.textContent = c.model ? money(c.base) : "—";
    els.optionsPrice.textContent = c.model ? money(c.options) : "—";
    els.unitTotal.textContent = c.model ? money(c.unit) : "—";
    els.qtyDisplay.textContent = String(c.qty);
    els.grandTotal.textContent = c.model ? money(c.total) : "—";

    if (v.ok){
      els.validDot.className = "dot ok";
      els.validText.textContent = "Ready";
    }else{
      els.validDot.className = "dot bad";
      els.validText.textContent = "Incomplete";
    }
    els.btnOrder.disabled = !v.ok;

    const steps = [];
    const groups = v.groups || [];
    const groupKeys = groups.map(item => item.key);
    if (!state.collapseAll){
      if (!state.openGroupKey || !groupKeys.includes(state.openGroupKey)){
        const firstIncomplete = groups.find(item => !item.isComplete);
        state.openGroupKey = (firstIncomplete ? firstIncomplete.key : groupKeys[0]) || "";
      }
    }else if (state.openGroupKey && !groupKeys.includes(state.openGroupKey)){
      state.openGroupKey = "";
    }

    const modelLabel = v.model ? v.model.label : "";
    steps.push(`
      <div class="step">
        <div class="shd">
          <span class="pill ok">1</span>
          <div style="flex:1">
            <div class="name">Model</div>
            <div class="meta">${escapeHtml(modelLabel || "Invalid route")}</div>
          </div>
          <div class="meta">${escapeHtml(modelLabel ? "Locked" : "—")}</div>
        </div>
        <div class="sbd">
          <div class="muted" style="font-size:12px;">This configurator is fixed to the ${escapeHtml(modelLabel || "selected")} model.</div>
        </div>
      </div>
    `);

    if (groups.length){
      steps.push(`
        <div class="accordion-toolbar">
          <button type="button" data-action="collapse-all">Collapse all</button>
        </div>
      `);
    }

    groups.forEach((groupState, index) => {
      const group = groupState.group;
      const label = group.label || titleCaseFromKey(groupState.key);
      const selected = groupState.selectedOption;
      const selectedLabel = selected ? selected.label : "Not selected";
      const metaText = groupState.fixed ? `${selectedLabel} (only option)` : selectedLabel;
      const priceText = selected ? (selected.price ? `+${money(selected.price)}` : money(0)) : "—";
      const showOk = groupState.isComplete;
      const requiredBadge = groupState.required && !groupState.selectedId ? `<span class="required-badge">Required</span>` : "";
      const isOpen = state.openGroupKey === groupState.key && !state.collapseAll;
      const optionCards = groupState.enabled.map((opt) => {
        const isSelected = opt.id === groupState.selectedId;
        const priceLabel = opt.price ? `+${money(opt.price)}` : money(0);
        const priceClass = opt.price ? "" : "hidden";
        const lockedAttr = groupState.fixed ? "disabled" : "";
        const crop = normalizeImageCrop(opt.imageCrop);
        const imgMarkup = opt.imageUrl
          ? `<img src="${escapeHtml(opt.imageUrl)}" alt="${escapeHtml(opt.label)}" loading="lazy" style="transform:${getCropTransform(crop)};" />`
          : `<span class="muted" style="font-size:11px;">No image</span>`;
        return `
          <button class="option-card ${isSelected ? "selected" : ""} ${groupState.fixed ? "locked" : ""}"
            type="button"
            data-action="select-option"
            data-group="${escapeHtml(groupState.key)}"
            data-option="${escapeHtml(opt.id)}"
            ${lockedAttr}>
            ${groupState.fixed ? `<span class="option-lock">Only option</span>` : ""}
            <span class="option-check">✓</span>
            <div class="option-thumb">
              <div class="option-thumb-viewport">${imgMarkup}</div>
            </div>
            <div class="option-title">${escapeHtml(opt.label)}</div>
            <span class="price-badge ${priceClass}">${escapeHtml(priceLabel)}</span>
          </button>
        `;
      }).join("");
      const nextGroupKey = groupKeys[index + 1] || "";
      const nextButton = nextGroupKey
        ? `<button type="button" data-action="next-group" data-next="${escapeHtml(nextGroupKey)}">Next</button>`
        : "";
      steps.push(`
        <div class="accordion-section" data-open="${isOpen ? "true" : "false"}">
          <button class="accordion-header" type="button" data-action="toggle" data-group="${escapeHtml(groupState.key)}">
            <span class="accordion-index ${showOk ? "ok" : ""}">${index + 2}</span>
            <div class="accordion-meta">
              <div class="name">${escapeHtml(label)}</div>
              <div class="sub">${escapeHtml(metaText)}</div>
            </div>
            <div class="accordion-actions">
              ${requiredBadge}
              <span>${escapeHtml(priceText)}</span>
              <span class="accordion-chevron">▾</span>
            </div>
          </button>
          <div class="accordion-body">
            <div class="options-grid">${optionCards || `<div class="muted" style="font-size:12px;">No options available.</div>`}</div>
            <div class="next-group">${nextButton}</div>
          </div>
        </div>
      `);
    });

    steps.push(`
      <div class="step">
        <div class="shd">
          <span class="pill ok">${groups.length + 2}</span>
          <div style="flex:1">
            <div class="name">Quantity</div>
            <div class="meta">How many bikes</div>
          </div>
          <div class="meta">—</div>
        </div>
        <div class="sbd">
          <label>Qty
            <input id="qtyInput" type="number" min="1" step="1" value="${escapeHtml(String(state.qty))}" />
          </label>
          <label style="margin-top:10px;">Notes (optional)
            <textarea id="notesInput" rows="3" placeholder="Internal notes...">${escapeHtml(state.notes || "")}</textarea>
          </label>
        </div>
      </div>
    `);

    els.stepsGrid.innerHTML = steps.join("");

    els.selectionList.innerHTML = "";
    const addLi = (label, val) => {
      const li = document.createElement("li");
      li.innerHTML = `<span class="muted">${escapeHtml(label)}:</span> ${escapeHtml(val)}`;
      els.selectionList.appendChild(li);
    };
    if (c.model) addLi("Model", c.model.label);
    (v.groups || []).forEach((groupState) => {
      if (groupState.selectedOption){
        addLi(groupState.group.label || titleCaseFromKey(groupState.key), groupState.selectedOption.label);
      }
    });
    addLi("Qty", String(c.qty));
    if (state.notes && state.notes.trim()) addLi("Notes", state.notes.trim());

    const layers = getSelectedImageLayers();
    renderComposite(layers);
    renderSkuPreview();

    saveState();
  }

  function renderAdmin(){
    if (!adminState.enabled){
      els.adminPanel.style.display = "none";
      return;
    }
    const modelIds = Object.keys(CONFIG.models || {});
    if (!adminState.modelId || !CONFIG.models[adminState.modelId]){
      adminState.modelId = modelIds[0] || "";
    }
    els.adminPanel.style.display = "flex";

    els.adminModelSelect.innerHTML = "";
    modelIds.forEach(id => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = CONFIG.models[id].label || id;
      els.adminModelSelect.appendChild(opt);
    });
    els.adminModelSelect.value = adminState.modelId;

    const model = CONFIG.models[adminState.modelId];
    const groupsOrder = model.groupsOrder || [];
    const groups = model.groups || {};
    if (!adminState.activeGroup || !groupsOrder.includes(adminState.activeGroup)){
      adminState.activeGroup = groupsOrder[0] || "";
    }

    if (!adminState.copySourceModelId || !CONFIG.models[adminState.copySourceModelId]){
      adminState.copySourceModelId = modelIds[0] || "";
    }
    const sourceModel = CONFIG.models[adminState.copySourceModelId];
    const sourceGroupsOrder = (sourceModel && sourceModel.groupsOrder) ? sourceModel.groupsOrder : [];
    if (!adminState.copySourceGroupKey || !sourceGroupsOrder.includes(adminState.copySourceGroupKey)){
      adminState.copySourceGroupKey = sourceGroupsOrder[0] || "";
    }
    if (!adminState.copyTargetBehavior){
      adminState.copyTargetBehavior = "new";
    }
    if (!adminState.copyTargetGroupKey){
      adminState.copyTargetGroupKey = adminState.copySourceGroupKey || "";
    }

    const fixedDigits = Array.isArray(model.skuFixedDigits) ? model.skuFixedDigits : [];
    const fixedEditorOpen = adminState.skuEditor && adminState.skuEditor.scope === "fixed";

    els.adminGroupsSection.innerHTML = `
      <div class="line" style="margin-bottom:8px;">
        <strong>Model Settings</strong>
      </div>
      <div class="sku-card" style="margin-bottom:12px;">
        <div class="sku-row">
          <span class="sku-label">SKU preview:</span>
          <span class="sku-value" id="adminSkuValue">—</span>
        </div>
        <div class="sku-row">
          <span class="sku-status" id="adminSkuStatus"></span>
          <button class="primary" data-action="sku-copy">Copy SKU</button>
        </div>
      </div>
      <div class="admin-help" style="margin-bottom:10px;">Manage fixed SKU digits that always apply to this model.</div>
      <div class="sku-cell" style="margin-bottom:12px;">
        <button class="primary" data-action="sku-fixed-toggle">Edit Fixed SKU digits</button>
        <div class="sku-summary">${escapeHtml(getSkuDigitsSummary(fixedDigits))}</div>
        <div class="sku-editor ${fixedEditorOpen ? "open" : ""}">
          ${fixedDigits.map((entry, entryIndex) => `
            <div class="sku-entry" data-entry="${entryIndex}">
              <label>Index
                <input type="number" min="1" step="1" value="${Number.isFinite(Number(entry.index)) ? Number(entry.index) : ""}" data-sku-field="fixed-index" data-entry="${entryIndex}">
              </label>
              <label>Value
                <input type="text" value="${escapeHtml(entry.value || "")}" data-sku-field="fixed-value" data-entry="${entryIndex}">
              </label>
              <button data-action="sku-fixed-remove" data-entry="${entryIndex}" class="danger">Remove</button>
            </div>
          `).join("")}
          <button data-action="sku-fixed-add">Add digit</button>
        </div>
      </div>
      <div class="hr" style="margin:10px 0;"></div>
      <div class="line" style="margin-bottom:8px;">
        <strong>Copy group from another model</strong>
      </div>
      <div class="admin-help" style="margin-bottom:10px;">Deep copy a group definition (label, required flag, and all option fields).</div>
      <div class="admin-inline" style="margin-bottom:10px;">
        <label>Source model
          <select id="adminCopySourceModel">
            ${modelIds.map((id) => `<option value="${escapeHtml(id)}">${escapeHtml(CONFIG.models[id].label || id)}</option>`).join("")}
          </select>
        </label>
        <label>Source group
          <select id="adminCopySourceGroup">
            ${sourceGroupsOrder.map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(sourceModel?.groups?.[key]?.label || titleCaseFromKey(key))}</option>`).join("")}
          </select>
        </label>
        <label class="small">Target group key
          <input id="adminCopyTargetKey" type="text" value="${escapeHtml(adminState.copyTargetGroupKey || "")}">
        </label>
      </div>
      <div class="admin-inline" style="margin-bottom:10px;">
        <label style="flex-direction:row; align-items:center; gap:6px; font-weight:700; color:var(--text);">
          <input type="radio" name="copyTargetBehavior" value="new" ${adminState.copyTargetBehavior === "new" ? "checked" : ""}>
          Copy as new group key
        </label>
        <label style="flex-direction:row; align-items:center; gap:6px; font-weight:700; color:var(--text);">
          <input type="radio" name="copyTargetBehavior" value="overwrite" ${adminState.copyTargetBehavior === "overwrite" ? "checked" : ""}>
          Overwrite existing group key
        </label>
        <button class="primary" data-action="group-copy">Copy group</button>
      </div>
      <div class="hr" style="margin:10px 0;"></div>
      <div class="line" style="margin-bottom:8px;">
        <strong>Option Groups</strong>
      </div>
      <div class="admin-help" style="margin-bottom:10px;">Manage group order, labels, and required flags.</div>
      ${groupsOrder.map((key, index) => {
        const group = groups[key] || { label: titleCaseFromKey(key), required: true };
        return `
          <div class="admin-group-row" data-group="${escapeHtml(key)}">
            <label>Group key
              <input type="text" value="${escapeHtml(key)}" data-field="groupKey" disabled>
            </label>
            <label>Label
              <input type="text" value="${escapeHtml(group.label || "")}" data-field="groupLabel">
            </label>
            <label>Required
              <input type="checkbox" data-field="groupRequired" ${group.required !== false ? "checked" : ""}>
            </label>
            <div class="admin-row-actions">
              <button data-action="group-move-up" ${index === 0 ? "disabled" : ""}>Up</button>
              <button data-action="group-move-down" ${index === groupsOrder.length - 1 ? "disabled" : ""}>Down</button>
              <button data-action="group-delete" class="danger">Delete</button>
            </div>
          </div>
        `;
      }).join("")}
      <div class="hr" style="margin:10px 0;"></div>
      <div class="admin-inline">
        <label class="small">Group key
          <input id="adminNewGroupKey" type="text" placeholder="saddle">
        </label>
        <label>Group label
          <input id="adminNewGroupLabel" type="text" placeholder="Saddle">
        </label>
        <label class="small">Required
          <input id="adminNewGroupRequired" type="checkbox" checked>
        </label>
        <button class="primary" data-action="group-add">Add Group</button>
      </div>
      <div class="admin-help">Key must be lowercase letters, numbers, dashes, or underscores. Example: saddle.</div>
    `;

    const activeGroup = adminState.activeGroup;
    const activeOptions = activeGroup ? (groups[activeGroup]?.options || []) : [];
    els.adminOptionsSection.innerHTML = `
      <div class="line" style="margin-bottom:8px;">
        <strong>Options Editor</strong>
        ${activeGroup ? `<button class="primary" data-action="option-add" data-group="${escapeHtml(activeGroup)}">Add option</button>` : ""}
      </div>
      <div class="admin-inline" style="margin-bottom:10px;">
        <label>Edit group
          <select id="adminGroupSelect">
            ${groupsOrder.map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(groups[key]?.label || titleCaseFromKey(key))}</option>`).join("")}
          </select>
        </label>
      </div>
      ${activeGroup ? `
        <table class="admin-table">
          <thead>
            <tr>
              <th style="width:120px;">ID</th>
              <th>Label</th>
              <th style="width:90px;">Price</th>
              <th>Image URL</th>
              <th style="width:120px;">Layer Priority</th>
              <th style="width:80px;">Enabled</th>
              <th style="width:240px;">Image Crop</th>
              <th style="width:220px;">SKU digits</th>
              <th style="width:200px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${activeOptions.map((opt, index) => `
              ${(() => {
                const crop = normalizeImageCrop(opt.imageCrop);
                return `
              <tr data-index="${index}" data-group="${escapeHtml(activeGroup)}">
                <td><input type="text" value="${escapeHtml(opt.id)}" data-field="id"></td>
                <td><input type="text" value="${escapeHtml(opt.label)}" data-field="label"></td>
                <td><input type="number" min="0" step="1" value="${Number.isFinite(opt.price) ? opt.price : 0}" data-field="price"></td>
                <td><input type="text" value="${escapeHtml(opt.imageUrl || "")}" data-field="imageUrl"></td>
                <td><input type="number" step="1" value="${Number.isFinite(Number(opt.layerPriority)) ? Number(opt.layerPriority) : 0}" data-field="layerPriority"></td>
                <td style="text-align:center;"><input type="checkbox" ${opt.enabled ? "checked" : ""} data-field="enabled"></td>
                <td>
                  <div class="crop-controls">
                    <div class="crop-row">
                      <label>X
                        <input type="number" min="0" max="1" step="0.01" value="${crop.x}" data-field="cropX">
                      </label>
                      <label>Y
                        <input type="number" min="0" max="1" step="0.01" value="${crop.y}" data-field="cropY">
                      </label>
                      <label>Zoom
                        <input type="number" min="1" step="0.05" value="${crop.zoom}" data-field="cropZoom">
                      </label>
                    </div>
                    <div class="crop-actions">
                      <button type="button" data-action="crop-center">Center</button>
                      <button type="button" data-action="crop-zoom-in">+</button>
                      <button type="button" data-action="crop-zoom-out">-</button>
                    </div>
                    <div class="crop-preview" title="Click to set crop center">
                      ${opt.imageUrl ? `<img src="${escapeHtml(opt.imageUrl)}" alt="${escapeHtml(opt.label)}" style="transform:${getCropTransform(crop)};" />` : ""}
                    </div>
                  </div>
                </td>
                <td>
                  <div class="sku-cell">
                    <button data-action="sku-toggle" data-group="${escapeHtml(activeGroup)}" data-index="${index}" class="primary">Edit</button>
                    <div class="sku-summary">${escapeHtml(getSkuDigitsSummary(opt.skuDigits))}</div>
                    <div class="sku-editor ${adminState.skuEditor && adminState.skuEditor.scope === "option" && adminState.skuEditor.groupKey === activeGroup && adminState.skuEditor.optionIndex === index ? "open" : ""}">
                      ${(Array.isArray(opt.skuDigits) ? opt.skuDigits : []).map((entry, entryIndex) => `
                        <div class="sku-entry" data-entry="${entryIndex}">
                          <label>Index
                            <input type="number" min="1" step="1" value="${Number.isFinite(Number(entry.index)) ? Number(entry.index) : ""}" data-sku-field="index" data-group="${escapeHtml(activeGroup)}" data-index="${index}" data-entry="${entryIndex}">
                          </label>
                          <label>Value
                            <input type="text" value="${escapeHtml(entry.value || "")}" data-sku-field="value" data-group="${escapeHtml(activeGroup)}" data-index="${index}" data-entry="${entryIndex}">
                          </label>
                          <button data-action="sku-remove" data-group="${escapeHtml(activeGroup)}" data-index="${index}" data-entry="${entryIndex}" class="danger">Remove</button>
                        </div>
                      `).join("")}
                      <button data-action="sku-add" data-group="${escapeHtml(activeGroup)}" data-index="${index}">Add digit</button>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="admin-row-actions">
                    <button data-action="option-move-up" ${index === 0 ? "disabled" : ""}>Up</button>
                    <button data-action="option-move-down" ${index === activeOptions.length - 1 ? "disabled" : ""}>Down</button>
                    <button data-action="option-top">Make this top</button>
                    <button data-action="option-bottom">Make this bottom</button>
                    <button data-action="option-delete" class="danger">Delete</button>
                  </div>
                </td>
              </tr>
              `;
              })()}
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="admin-help">Add a group to start editing options.</div>`}
    `;

    const comboLayers = getComboLayers(model);
    els.adminComboLayersSection.innerHTML = `
      <div class="line" style="margin-bottom:8px;">
        <strong>Combo layers</strong>
        <button class="primary" data-action="combo-add">Add combo layer</button>
      </div>
      <div class="admin-help" style="margin-bottom:10px;">
        Combo layers use two groups to map specific option combinations to a single image layer.
      </div>
      ${comboLayers.length ? comboLayers.map((layer, index) => {
        const dependsOn = Array.isArray(layer.dependsOn) ? layer.dependsOn : [];
        const groupAKey = dependsOn[0] || "";
        const groupBKey = dependsOn[1] || "";
        const combos = getComboLayerCombinations(model, layer);
        const map = layer.map && typeof layer.map === "object" ? layer.map : {};
        const missingCount = combos.filter((combo) => !String(map[combo.key] || "").trim()).length;
        const totalCount = combos.length;
        return `
          <div class="combo-layer-card" data-layer-index="${index}">
            <div class="combo-layer-header">
              <strong>${escapeHtml(layer.label || layer.id || "Combo layer")}</strong>
              <div class="admin-row-actions">
                <button data-action="combo-delete" class="danger" data-layer-index="${index}">Delete</button>
              </div>
            </div>
            <div class="combo-layer-fields">
              <label>Id
                <input type="text" value="${escapeHtml(layer.id || "")}" data-field="comboId" data-layer-index="${index}">
              </label>
              <label>Label
                <input type="text" value="${escapeHtml(layer.label || "")}" data-field="comboLabel" data-layer-index="${index}">
              </label>
              <label>Layer priority
                <input type="number" step="1" value="${Number.isFinite(Number(layer.layerPriority)) ? Number(layer.layerPriority) : 0}" data-field="comboLayerPriority" data-layer-index="${index}">
              </label>
              <label style="flex-direction:row; align-items:center; gap:6px; font-weight:700; color:var(--text);">
                <input type="checkbox" ${layer.enabled !== false ? "checked" : ""} data-field="comboEnabled" data-layer-index="${index}">
                Enabled
              </label>
              <label>Group A
                <select data-field="comboDependsA" data-layer-index="${index}">
                  <option value="">Select group</option>
                  ${groupsOrder.map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(groups[key]?.label || titleCaseFromKey(key))}</option>`).join("")}
                </select>
              </label>
              <label>Group B
                <select data-field="comboDependsB" data-layer-index="${index}">
                  <option value="">Select group</option>
                  ${groupsOrder.map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(groups[key]?.label || titleCaseFromKey(key))}</option>`).join("")}
                </select>
              </label>
            </div>
            <div class="combo-layer-map">
              <div class="admin-inline" style="justify-content:space-between; margin-bottom:8px;">
                <div class="admin-help">Mapping key uses "${escapeHtml(groupAKey || "groupA")}|${escapeHtml(groupBKey || "groupB")}".</div>
                <button class="primary" data-action="combo-generate" data-layer-index="${index}">Generate combinations</button>
              </div>
              ${totalCount ? `
                <div class="admin-help ${missingCount ? "warn" : ""}" style="margin-bottom:8px;">
                  ${missingCount ? `${missingCount} of ${totalCount} combinations missing image URLs.` : "All combinations mapped."}
                </div>
                <table>
                  <thead>
                    <tr>
                      <th>Option A</th>
                      <th>Option B</th>
                      <th>Key</th>
                      <th>Image URL</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${combos.map((combo) => `
                      <tr>
                        <td>${escapeHtml(combo.optionA.label || combo.optionA.id)}</td>
                        <td>${escapeHtml(combo.optionB.label || combo.optionB.id)}</td>
                        <td>${escapeHtml(combo.key)}</td>
                        <td>
                          <input type="text" value="${escapeHtml(map[combo.key] || "")}" data-field="comboMapValue" data-key="${escapeHtml(combo.key)}" data-layer-index="${index}">
                        </td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>
              ` : `<div class="admin-help">Select two groups to generate mapping rows.</div>`}
            </div>
          </div>
        `;
      }).join("") : `<div class="admin-help">No combo layers yet. Add one to start mapping combinations.</div>`}
    `;

    const adminGroupSelect = document.getElementById("adminGroupSelect");
    if (adminGroupSelect){
      adminGroupSelect.value = activeGroup;
    }
    const adminCopySourceModel = document.getElementById("adminCopySourceModel");
    if (adminCopySourceModel){
      adminCopySourceModel.value = adminState.copySourceModelId;
    }
    const adminCopySourceGroup = document.getElementById("adminCopySourceGroup");
    if (adminCopySourceGroup){
      adminCopySourceGroup.value = adminState.copySourceGroupKey;
    }
    const comboDependsSelects = els.adminComboLayersSection.querySelectorAll("select[data-field]");
    comboDependsSelects.forEach((select) => {
      const layerIndex = Number(select.dataset.layerIndex);
      const layer = comboLayers[layerIndex];
      if (!layer) return;
      if (select.dataset.field === "comboDependsA"){
        select.value = (Array.isArray(layer.dependsOn) ? layer.dependsOn[0] : "") || "";
      }
      if (select.dataset.field === "comboDependsB"){
        select.value = (Array.isArray(layer.dependsOn) ? layer.dependsOn[1] : "") || "";
      }
    });
    updateAdminStatus();
    renderSkuPreview();
  }

  function escapeHtml(str){
    return String(str || "").replace(/[&<>"]+/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;"
    }[m] || m));
  }

  // =========================
  // BIGCOMMERCE CART HELPERS
  // =========================
  function submitCartForm(qty, attribute116Value){
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/cart.php";
    form.target = "hiddenCartFrame";

    const addInput = (name, value) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = value;
      form.appendChild(input);
    };

    addInput("action", "add");
    addInput("product_id", String(PRODUCT_ID));
    addInput("qty[]", String(qty));
    addInput("attribute[116]", attribute116Value);

    document.body.appendChild(form);
    form.submit();
    form.remove();
  }

  // =========================
  // ADMIN HELPERS
  // =========================
  function openAdminPrompt(){
    els.adminPrompt.style.display = "flex";
    els.adminPassword.value = "";
    els.adminPassword.focus();
  }

  function closeAdminPrompt(){
    els.adminPrompt.style.display = "none";
  }

  function enableAdminMode(){
    adminState.enabled = true;
    saveAdminState();
    toast("Admin mode enabled");
    renderAdmin();
  }

  function disableAdminMode(){
    adminState.enabled = false;
    saveAdminState();
    els.adminPanel.style.display = "none";
    toast("Admin mode disabled");
  }

  // =========================
  // EVENTS
  // =========================
  els.stepsGrid.addEventListener("click", (e)=>{
    const actionEl = e.target.closest("[data-action]");
    if (!actionEl) return;
    const action = actionEl.dataset.action;
    if (action === "toggle"){
      const groupKey = actionEl.dataset.group;
      if (!groupKey) return;
      if (state.openGroupKey === groupKey && !state.collapseAll){
        state.openGroupKey = "";
        state.collapseAll = true;
      }else{
        state.openGroupKey = groupKey;
        state.collapseAll = false;
      }
      renderBuyer();
      return;
    }
    if (action === "collapse-all"){
      state.openGroupKey = "";
      state.collapseAll = true;
      renderBuyer();
      return;
    }
    if (action === "next-group"){
      const nextKey = actionEl.dataset.next || "";
      state.openGroupKey = nextKey;
      state.collapseAll = false;
      renderBuyer();
      return;
    }
    if (action === "select-option"){
      const groupKey = actionEl.dataset.group;
      const optionId = actionEl.dataset.option;
      if (!groupKey || !optionId) return;
      state.selections[groupKey] = optionId;
      state.collapseAll = false;
      renderBuyer();
    }
  });

  els.stepsGrid.addEventListener("input", (e)=>{
    const target = e.target;
    if (target && target.id === "qtyInput"){
      state.qty = normalizeQty(target.value);
      renderBuyer();
    }
    if (target && target.id === "notesInput"){
      state.notes = target.value || "";
      renderBuyer();
    }
  });

  els.btnReset.addEventListener("click", ()=>{
    state.modelId = "";
    state.selections = {};
    state.qty = 1;
    state.notes = "";
    state.openGroupKey = "";
    state.collapseAll = false;
    renderBuyer();
    toast("Reset complete.");
  });

  els.btnCopyJson.addEventListener("click", async ()=>{
    const txt = exportConfig();
    try{
      await navigator.clipboard.writeText(txt);
      toast("Config JSON copied.");
    }catch(e){
      prompt("Copy JSON:", txt);
    }
  });

  els.btnCopySku.addEventListener("click", ()=>{
    copySkuToClipboard();
  });

  els.btnOrder.addEventListener("click", ()=>{
    const attributeResult = buildAttribute116Value();
    if (attributeResult.missing.length){
      const message = `Please complete: ${attributeResult.missing.join(", ")}`;
      toast("Complete required selections before ordering.");
      alert(message);
      return;
    }

    const qty = normalizeQty(state.qty);

    els.btnOrder.disabled = true;
    els.btnOrder.textContent = "Ordering…";

    submitCartForm(qty, attributeResult.value);
    toast("Added to cart. Returning home…");
    setTimeout(() => {
      window.location.href = HOME_URL;
    }, 700);
  });

  els.btnDownloadComposite.addEventListener("click", ()=>{
    const layers = getSelectedImageLayers();
    const background = els.compositeWhiteBg && els.compositeWhiteBg.checked ? "white" : "transparent";
    exportCompositePNG(layers, { background });
  });

  els.btnAdmin.addEventListener("click", ()=>{
    if (adminState.enabled){
      renderAdmin();
      return;
    }
    openAdminPrompt();
  });

  els.adminCancel.addEventListener("click", ()=>{
    closeAdminPrompt();
  });

  els.adminSubmit.addEventListener("click", ()=>{
    const value = els.adminPassword.value || "";
    if (value === ADMIN_PASSWORD){
      closeAdminPrompt();
      enableAdminMode();
    }else{
      toast("Wrong password");
    }
  });

  els.adminPassword.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){
      els.adminSubmit.click();
    }
  });

  els.btnExitAdmin.addEventListener("click", ()=>{
    disableAdminMode();
  });

  async function refreshConfigFromSheet(){
    try{
      CONFIG = normalizeConfig(await fetchConfigFromSheet());
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config refreshed from sheet.");
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to refresh config from sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to refresh from Sheet: ${message}`);
      return false;
    }
  }

  els.btnRefreshSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetDefaults.addEventListener("click", ()=>{
    CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));
    reconcileSelections();
    renderBuyer();
    renderAdmin();
    toast("Reset to local defaults.");
  });

  els.btnSaveSheet.addEventListener("click", ()=>{
    saveConfigFlow();
  });

  els.adminModelSelect.addEventListener("change", (e)=>{
    adminState.modelId = e.target.value;
    renderAdmin();
  });

  els.adminGroupsSection.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    if (action === "sku-copy"){
      copySkuToClipboard();
      return;
    }
    if (action === "sku-fixed-toggle"){
      if (adminState.skuEditor && adminState.skuEditor.scope === "fixed"){
        adminState.skuEditor = null;
      }else{
        adminState.skuEditor = { scope: "fixed" };
      }
      renderAdmin();
      return;
    }
    if (action === "sku-fixed-add"){
      model.skuFixedDigits = Array.isArray(model.skuFixedDigits) ? model.skuFixedDigits : [];
      model.skuFixedDigits.push({ index: 1, value: "X" });
      adminState.skuEditor = { scope: "fixed" };
      renderBuyer();
      renderAdmin();
      return;
    }
    if (action === "sku-fixed-remove"){
      const entryIndex = Number(actionBtn.dataset.entry);
      model.skuFixedDigits = Array.isArray(model.skuFixedDigits) ? model.skuFixedDigits : [];
      if (Number.isFinite(entryIndex) && model.skuFixedDigits[entryIndex]){
        model.skuFixedDigits.splice(entryIndex, 1);
        adminState.skuEditor = { scope: "fixed" };
        renderBuyer();
        renderAdmin();
      }
      return;
    }
    if (action === "group-copy"){
      const sourceModelId = adminState.copySourceModelId;
      const sourceGroupKey = adminState.copySourceGroupKey;
      const targetBehavior = adminState.copyTargetBehavior || "new";
      const targetGroupKey = (adminState.copyTargetGroupKey || "").trim();
      if (!sourceModelId || !CONFIG.models[sourceModelId]){
        toast("Select a valid source model.");
        return;
      }
      const sourceModel = CONFIG.models[sourceModelId];
      if (!sourceGroupKey || !sourceModel.groups || !sourceModel.groups[sourceGroupKey]){
        toast("Select a valid source group.");
        return;
      }
      if (!/^[a-z0-9_-]+$/.test(targetGroupKey)){
        toast("Target group key must be lowercase letters, numbers, dashes, or underscores.");
        return;
      }
      model.groups = model.groups || {};
      model.groupsOrder = model.groupsOrder || [];
      const exists = !!model.groups[targetGroupKey];
      if (targetBehavior === "new" && exists){
        toast(`Group key "${targetGroupKey}" already exists. Choose overwrite or a new key.`);
        return;
      }
      const clonedGroup = deepClone(sourceModel.groups[sourceGroupKey]);
      model.groups[targetGroupKey] = clonedGroup;
      if (!model.groupsOrder.includes(targetGroupKey)){
        model.groupsOrder.push(targetGroupKey);
      }
      adminState.activeGroup = targetGroupKey;
      renderBuyer();
      renderAdmin();
      toast(`Group "${sourceGroupKey}" copied to "${targetGroupKey}".`);
      return;
    }
    if (action === "group-add"){
      const keyInput = document.getElementById("adminNewGroupKey");
      const labelInput = document.getElementById("adminNewGroupLabel");
      const requiredInput = document.getElementById("adminNewGroupRequired");
      const key = (keyInput?.value || "").trim();
      const label = (labelInput?.value || "").trim();
      const required = requiredInput ? requiredInput.checked : true;
      if (!/^[a-z0-9_-]+$/.test(key)){
        toast("Group key must be lowercase letters, numbers, dashes, or underscores.");
        return;
      }
      if (model.groups && model.groups[key]){
        toast(`Group key "${key}" already exists.`);
        return;
      }
      if (!label){
        toast("Group label is required.");
        return;
      }
      model.groups = model.groups || {};
      model.groups[key] = {
        label,
        required,
        options: []
      };
      model.groupsOrder = model.groupsOrder || [];
      model.groupsOrder.push(key);
      adminState.activeGroup = key;
      renderBuyer();
      renderAdmin();
      return;
    }
    const row = actionBtn.closest(".admin-group-row");
    const groupKey = row ? row.dataset.group : "";
    if (!groupKey) return;
    if (action === "group-delete"){
      model.groupsOrder = (model.groupsOrder || []).filter((key) => key !== groupKey);
      if (model.groups){
        delete model.groups[groupKey];
      }
      if (state.selections && state.selections[groupKey]){
        delete state.selections[groupKey];
      }
      if (adminState.activeGroup === groupKey){
        adminState.activeGroup = model.groupsOrder[0] || "";
      }
      renderBuyer();
      renderAdmin();
      return;
    }
    const index = model.groupsOrder.indexOf(groupKey);
    if (action === "group-move-up" && index > 0){
      [model.groupsOrder[index - 1], model.groupsOrder[index]] = [model.groupsOrder[index], model.groupsOrder[index - 1]];
    }
    if (action === "group-move-down" && index < model.groupsOrder.length - 1){
      [model.groupsOrder[index + 1], model.groupsOrder[index]] = [model.groupsOrder[index], model.groupsOrder[index + 1]];
    }
    renderBuyer();
    renderAdmin();
  });

  els.adminGroupsSection.addEventListener("input", (e)=>{
    const input = e.target;
    if (input && input.id === "adminCopyTargetKey"){
      adminState.copyTargetGroupKey = input.value.trim();
      return;
    }
    const row = input.closest(".admin-group-row");
    if (!row) return;
    const groupKey = row.dataset.group;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[groupKey]) return;
    const group = model.groups[groupKey];
    const field = input.dataset.field;
    if (field === "groupLabel"){
      group.label = input.value.trim();
    }
    if (field === "groupRequired"){
      group.required = input.checked;
    }
    updateAdminStatus();
    renderBuyer();
  });

  els.adminGroupsSection.addEventListener("change", (e)=>{
    const target = e.target;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    if (target && target.id === "adminCopySourceModel"){
      const previousSourceGroup = adminState.copySourceGroupKey;
      adminState.copySourceModelId = target.value;
      const sourceModel = CONFIG.models[adminState.copySourceModelId];
      const sourceGroups = sourceModel?.groupsOrder || [];
      adminState.copySourceGroupKey = sourceGroups[0] || "";
      if (!adminState.copyTargetGroupKey || adminState.copyTargetGroupKey === previousSourceGroup){
        adminState.copyTargetGroupKey = adminState.copySourceGroupKey || "";
      }
      renderAdmin();
      return;
    }
    if (target && target.id === "adminCopySourceGroup"){
      const previousSourceGroup = adminState.copySourceGroupKey;
      adminState.copySourceGroupKey = target.value;
      if (!adminState.copyTargetGroupKey || adminState.copyTargetGroupKey === previousSourceGroup){
        adminState.copyTargetGroupKey = adminState.copySourceGroupKey || "";
      }
      renderAdmin();
      return;
    }
    if (target && target.name === "copyTargetBehavior"){
      adminState.copyTargetBehavior = target.value;
      return;
    }
    if (!target || !target.dataset || !target.dataset.skuField) return;
    const field = target.dataset.skuField;
    if (!field.startsWith("fixed-")) return;
    model.skuFixedDigits = Array.isArray(model.skuFixedDigits) ? model.skuFixedDigits : [];
    const entryIndex = Number(target.dataset.entry);
    const entry = model.skuFixedDigits[entryIndex];
    if (!entry) return;
    if (field === "fixed-index"){
      const parsed = parseSkuIndex(target.value);
      if (parsed === null){
        toast("SKU index must be an integer of 1 or higher.");
        target.value = entry.index ?? "";
        return;
      }
      entry.index = parsed;
    }
    if (field === "fixed-value"){
      const value = target.value;
      if (!validateSkuValue(value)){
        toast("SKU value must be a non-empty string.");
        target.value = entry.value ?? "";
        return;
      }
      entry.value = value;
    }
    updateAdminStatus();
    renderBuyer();
  });

  els.adminOptionsSection.addEventListener("change", (e)=>{
    const target = e.target;
    if (target && target.dataset && target.dataset.skuField){
      const field = target.dataset.skuField;
      const group = target.dataset.group;
      const index = Number(target.dataset.index);
      const entryIndex = Number(target.dataset.entry);
      const model = CONFIG.models[adminState.modelId];
      if (!model || !model.groups || !model.groups[group] || !model.groups[group].options[index]) return;
      const option = model.groups[group].options[index];
      option.skuDigits = Array.isArray(option.skuDigits) ? option.skuDigits : [];
      const entry = option.skuDigits[entryIndex];
      if (!entry) return;
      if (field === "index"){
        const parsed = parseSkuIndex(target.value);
        if (parsed === null){
          toast("SKU index must be an integer of 1 or higher.");
          target.value = entry.index ?? "";
          return;
        }
        entry.index = parsed;
      }
      if (field === "value"){
        const value = target.value;
        if (!validateSkuValue(value)){
          toast("SKU value must be a non-empty string.");
          target.value = entry.value ?? "";
          return;
        }
        entry.value = value;
      }
      updateAdminStatus();
      renderBuyer();
      return;
    }
    if (target && target.id === "adminGroupSelect"){
      adminState.activeGroup = target.value;
      renderAdmin();
    }
  });

  els.adminOptionsSection.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const group = actionBtn.dataset.group || actionBtn.closest("tr")?.dataset.group;
    if (!group) return;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[group]) return;
    const options = model.groups[group].options || [];
    if (action === "sku-toggle"){
      const index = Number(actionBtn.dataset.index);
      if (adminState.skuEditor && adminState.skuEditor.scope === "option" && adminState.skuEditor.groupKey === group && adminState.skuEditor.optionIndex === index){
        adminState.skuEditor = null;
      }else{
        adminState.skuEditor = { scope: "option", groupKey: group, optionIndex: index };
      }
      renderAdmin();
      return;
    }
    if (action === "sku-add"){
      const index = Number(actionBtn.dataset.index);
      if (!options[index]) return;
      options[index].skuDigits = Array.isArray(options[index].skuDigits) ? options[index].skuDigits : [];
      options[index].skuDigits.push({ index: 1, value: "X" });
      adminState.skuEditor = { scope: "option", groupKey: group, optionIndex: index };
      renderBuyer();
      renderAdmin();
      return;
    }
    if (action === "sku-remove"){
      const index = Number(actionBtn.dataset.index);
      const entryIndex = Number(actionBtn.dataset.entry);
      if (!options[index]) return;
      options[index].skuDigits = Array.isArray(options[index].skuDigits) ? options[index].skuDigits : [];
      if (Number.isFinite(entryIndex) && options[index].skuDigits[entryIndex]){
        options[index].skuDigits.splice(entryIndex, 1);
        adminState.skuEditor = { scope: "option", groupKey: group, optionIndex: index };
        renderBuyer();
        renderAdmin();
      }
      return;
    }
    if (action === "crop-center" || action === "crop-zoom-in" || action === "crop-zoom-out"){
      const row = actionBtn.closest("tr");
      const index = row ? Number(row.dataset.index) : -1;
      if (index < 0 || !options[index]) return;
      const option = options[index];
      const current = normalizeImageCrop(option.imageCrop);
      if (action === "crop-center"){
        updateImageCrop(option, { x: 0.5, y: 0.5 });
      }
      if (action === "crop-zoom-in"){
        updateImageCrop(option, { zoom: current.zoom + 0.25 });
      }
      if (action === "crop-zoom-out"){
        updateImageCrop(option, { zoom: Math.max(1, current.zoom - 0.25) });
      }
      renderBuyer();
      renderAdmin();
      return;
    }
    if (action === "option-add"){
      options.push({
        id: `new-${Date.now()}`,
        label: "",
        price: 0,
        imageUrl: "",
        enabled: true,
        layerPriority: 0,
        skuDigits: [],
        imageCrop: { ...DEFAULT_IMAGE_CROP }
      });
      renderBuyer();
      renderAdmin();
      return;
    }
    const row = actionBtn.closest("tr");
    const index = row ? Number(row.dataset.index) : -1;
    if (index < 0) return;
    if (action === "option-delete"){
      options.splice(index, 1);
    }
    if (action === "option-move-up" && index > 0){
      [options[index - 1], options[index]] = [options[index], options[index - 1]];
    }
    if (action === "option-move-down" && index < options.length - 1){
      [options[index + 1], options[index]] = [options[index], options[index + 1]];
    }
    if (action === "option-top"){
      options[index].layerPriority = 1000;
    }
    if (action === "option-bottom"){
      options[index].layerPriority = -1000;
    }
    renderBuyer();
    renderAdmin();
  });

  els.adminOptionsSection.addEventListener("input", (e)=>{
    const input = e.target;
    const row = input.closest("tr");
    if (!row) return;
    const group = row.dataset.group;
    const index = Number(row.dataset.index);
    const field = input.dataset.field;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[group] || !model.groups[group].options[index]) return;
    const option = model.groups[group].options[index];
    if (field === "enabled"){
      option.enabled = input.checked;
    }else if (field === "price"){
      option.price = Number(input.value);
    }else if (field === "layerPriority"){
      const parsed = Number(input.value);
      option.layerPriority = Number.isFinite(parsed) ? Math.trunc(parsed) : 0;
    }else if (field === "id"){
      option.id = input.value.trim();
    }else if (field === "label"){
      option.label = input.value;
    }else if (field === "imageUrl"){
      option.imageUrl = input.value.trim();
    }else if (field === "cropX" || field === "cropY" || field === "cropZoom"){
      const updates = {};
      if (field === "cropX"){
        updates.x = Number(input.value);
      }
      if (field === "cropY"){
        updates.y = Number(input.value);
      }
      if (field === "cropZoom"){
        updates.zoom = Number(input.value);
      }
      const crop = updateImageCrop(option, updates);
      const previewImg = row.querySelector(".crop-preview img");
      if (previewImg){
        previewImg.style.transform = getCropTransform(crop);
      }
    }
    updateAdminStatus();
    renderBuyer();
  });

  els.adminOptionsSection.addEventListener("click", (e)=>{
    const preview = e.target.closest(".crop-preview");
    if (!preview) return;
    const row = preview.closest("tr");
    if (!row) return;
    const group = row.dataset.group;
    const index = Number(row.dataset.index);
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[group] || !model.groups[group].options[index]) return;
    const option = model.groups[group].options[index];
    const rect = preview.getBoundingClientRect();
    if (!rect.width || !rect.height) return;
    const x = (e.clientX - rect.left) / rect.width;
    const y = (e.clientY - rect.top) / rect.height;
    updateImageCrop(option, { x, y });
    renderBuyer();
    renderAdmin();
  });

  els.adminComboLayersSection.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    model.comboLayers = Array.isArray(model.comboLayers) ? model.comboLayers : [];
    if (action === "combo-add"){
      const groupKeys = model.groupsOrder || [];
      const groupAKey = groupKeys[0] || "";
      const groupBKey = groupKeys[1] || "";
      const nextId = `combo-${Date.now()}`;
      model.comboLayers.push({
        id: nextId,
        label: "New combo layer",
        enabled: true,
        layerPriority: 0,
        dependsOn: [groupAKey, groupBKey],
        map: {}
      });
      renderBuyer();
      renderAdmin();
      return;
    }
    if (action === "combo-delete"){
      const index = Number(actionBtn.dataset.layerIndex);
      if (!Number.isFinite(index) || !model.comboLayers[index]) return;
      model.comboLayers.splice(index, 1);
      renderBuyer();
      renderAdmin();
      return;
    }
    if (action === "combo-generate"){
      const index = Number(actionBtn.dataset.layerIndex);
      const layer = model.comboLayers[index];
      if (!layer) return;
      layer.map = layer.map && typeof layer.map === "object" ? layer.map : {};
      const combos = getComboLayerCombinations(model, layer);
      combos.forEach((combo) => {
        if (!(combo.key in layer.map)){
          layer.map[combo.key] = "";
        }
      });
      renderBuyer();
      renderAdmin();
      return;
    }
  });

  els.adminComboLayersSection.addEventListener("input", (e)=>{
    const input = e.target;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    const layerIndex = Number(input.dataset.layerIndex);
    const layer = Array.isArray(model.comboLayers) ? model.comboLayers[layerIndex] : null;
    if (!layer) return;
    const field = input.dataset.field;
    if (field === "comboId"){
      layer.id = input.value.trim();
    }else if (field === "comboLabel"){
      layer.label = input.value;
    }else if (field === "comboLayerPriority"){
      const parsed = Number(input.value);
      layer.layerPriority = Number.isFinite(parsed) ? Math.trunc(parsed) : 0;
    }else if (field === "comboEnabled"){
      layer.enabled = input.checked;
    }else if (field === "comboMapValue"){
      layer.map = layer.map && typeof layer.map === "object" ? layer.map : {};
      const key = input.dataset.key || "";
      layer.map[key] = input.value.trim();
    }
    updateAdminStatus();
    renderBuyer();
  });

  els.adminComboLayersSection.addEventListener("change", (e)=>{
    const select = e.target;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    const layerIndex = Number(select.dataset.layerIndex);
    const layer = Array.isArray(model.comboLayers) ? model.comboLayers[layerIndex] : null;
    if (!layer) return;
    const field = select.dataset.field;
    if (field === "comboDependsA" || field === "comboDependsB"){
      layer.dependsOn = Array.isArray(layer.dependsOn) ? layer.dependsOn : ["", ""];
      if (field === "comboDependsA"){
        layer.dependsOn[0] = select.value;
      }else{
        layer.dependsOn[1] = select.value;
      }
      renderBuyer();
      renderAdmin();
    }
  });

  // =========================
  // INIT
  // =========================
  loadState();
  loadAdminState();
  renderBuyer();
  if (routeError){
    toast(routeError);
  }
  if (adminState.enabled){
    renderAdmin();
  }
  loadConfigFromSheet(true);
})();
</script>
</body>
</html>
