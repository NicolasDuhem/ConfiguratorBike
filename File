<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bike Configurator (HTML Only)</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --text:#101218;
      --muted:#5b6475;
      --accent:#1f4bff;
      --ok:#1f9d67;
      --bad:#d64550;
      --border:rgba(16,18,24,.12);
      --shadow: 0 12px 30px rgba(15,23,42,.12);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 40px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 18px;
    }
    header{
      grid-column: 1 / -1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    .title{display:flex; flex-direction:column; gap:6px}
    h1{margin:0; font-size: 22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; line-height:1.4}

    .top-actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button{
      appearance:none; border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      box-shadow: 0 6px 16px rgba(15,23,42,.08);
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{border-color: rgba(31,75,255,.35)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(31,75,255,.35);
      background: rgba(31,75,255,.08);
    }
    button.success{
      border-color: rgba(31,157,103,.35);
      background: rgba(31,157,103,.10);
    }
    button.danger{
      border-color: rgba(214,69,80,.35);
      background: rgba(214,69,80,.08);
    }

    .panel{
      background: #fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hd .h2{font-weight: 800; font-size: 14px; letter-spacing:.2px}
    .panel .bd{padding: 14px}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      .grid{grid-template-columns:1fr}
    }

    .step{
      border:1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      overflow:hidden;
    }
    .step .shd{
      padding: 12px 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
    }
    .pill{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(31,75,255,.12);
      border:1px solid rgba(31,75,255,.25);
      color: #1f2d6a;
    }
    .pill.ok{
      background: rgba(31,157,103,.12);
      border-color: rgba(31,157,103,.25);
      color:#0f5b3c;
    }
    .step .shd .name{font-weight: 800; font-size: 13px}
    .step .shd .meta{font-size:12px; color: var(--muted)}
    .step .sbd{padding: 12px}

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    select, input[type="number"], textarea, input[type="text"], input[type="password"]{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-weight:700;
    }
    select:disabled, input:disabled, textarea:disabled{
      background: #f0f2f6;
      color: #7c8597;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(31,75,255,.5);
      box-shadow: 0 0 0 3px rgba(31,75,255,.12);
    }

    .summary{display:flex; flex-direction:column; gap:12px}
    .totals{
      display:flex; flex-direction:column; gap:8px;
      padding: 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .line{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 13px}
    .line strong{font-size: 14px}
    .hr{height:1px; background: var(--border); margin:6px 0}
    .items{
      padding: 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .items ul{margin:0; padding-left: 18px}
    .items li{margin:6px 0; color:#1d2435}
    .muted{color:var(--muted)}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:800;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      width: fit-content;
    }
    .dot{width:10px; height:10px; border-radius: 999px; background: rgba(16,18,24,.3)}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 13px;
      display:none;
      max-width: 420px;
      z-index: 999;
      white-space: pre-wrap;
    }

    .option-preview{
      margin-top: 8px;
      max-height: 120px;
      width: 100%;
      object-fit: contain;
      border: 1px solid rgba(16,18,24,.12);
      border-radius: 12px;
      display:none;
      background:#fff;
    }
    .composite-card{
      padding: 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .composite-preview{
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 16 / 9;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .composite-preview img{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      image-rendering: auto;
    }
    .composite-empty{
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      padding: 12px;
    }
    .composite-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .layers-list{
      display:grid;
      gap:10px;
    }
    .layer-item{
      display:grid;
      grid-template-columns: 54px 1fr;
      gap:10px;
      align-items:center;
      padding: 10px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: #fff;
    }
    .layer-thumb{
      width: 54px;
      height: 40px;
      border-radius: 10px;
      border:1px solid var(--border);
      background:#fff;
      object-fit: contain;
    }
    .layer-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .layer-meta{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .layer-title{
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .admin-overlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
    }
    .admin-modal{
      background:#fff;
      border-radius: 16px;
      padding: 18px;
      width: min(420px, 90vw);
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    .admin-modal h3{margin:0 0 10px; font-size:16px}
    .admin-panel{
      position: fixed;
      inset: auto 12px 12px 12px;
      background:#fff;
      border-radius: 16px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      max-height: 80vh;
      display:none;
      flex-direction:column;
      z-index: 998;
    }
    .admin-panel .admin-header{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: #f9faff;
      flex-wrap:wrap;
    }
    .admin-panel .admin-body{
      padding: 14px;
      overflow:auto;
      display:grid;
      gap: 12px;
    }
    .admin-actions{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs button{padding:6px 10px; font-size:12px}
    .admin-tabs button.active{border-color: rgba(31,75,255,.6); background: rgba(31,75,255,.12)}
    .admin-section{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #fafbff;
    }
    .admin-table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .admin-table th,
    .admin-table td{
      border-bottom:1px solid var(--border);
      padding: 6px;
      text-align:left;
      vertical-align:top;
    }
    .admin-table th{color: var(--muted); font-weight:700}
    .admin-row-actions{display:flex; gap:6px; flex-wrap:wrap}
    .admin-row-actions button{padding:6px 8px; font-size:11px}
    .status-line{font-size:12px; color: var(--muted)}
    .status-line.warn{color: var(--bad); font-weight: 800}
    .admin-group-row{
      display:grid;
      grid-template-columns: 120px 1fr 110px 1fr;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .admin-inline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .admin-inline label{flex:1}
    .admin-inline .small{max-width: 180px}
    .admin-inline input[type="checkbox"]{width:auto}
    .admin-help{font-size:12px; color: var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Bike Configurator</h1>
        <div class="sub">
          HTML-only. Click <b>Order</b> to add Product <b>#114</b> to cart and return to home.
        </div>
      </div>

      <div class="top-actions">
        <button id="btnAdmin" class="primary">ADMIN</button>
        <button id="btnReset">Reset</button>
        <button id="btnCopyJson">Copy JSON</button>
        <button id="btnOrder" class="success">Order (Add to Cart)</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="panel">
      <div class="hd">
        <div class="h2">Build your bike</div>
        <div class="muted" style="font-size:12px">
          Adds to cart via Storefront Cart API.
        </div>
      </div>
      <div class="bd">
        <div class="grid" id="stepsGrid"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel">
      <div class="hd">
        <div class="h2">Summary</div>
        <div class="badge" id="validBadge">
          <span class="dot bad" id="validDot"></span>
          <span id="validText">Incomplete</span>
        </div>
      </div>
      <div class="bd summary">
        <div class="totals">
          <div class="line"><span>Base price</span><strong id="basePrice">—</strong></div>
          <div class="line"><span>Options</span><strong id="optionsPrice">—</strong></div>
          <div class="hr"></div>
          <div class="line"><span>Unit total</span><strong id="unitTotal">—</strong></div>
          <div class="line"><span>Quantity</span><strong id="qtyDisplay">—</strong></div>
          <div class="hr"></div>
          <div class="line"><span>Grand total</span><strong id="grandTotal">—</strong></div>
        </div>

        <div class="items">
          <div class="line" style="margin-bottom:8px;">
            <strong>Selected</strong>
            <span class="muted">Product ID for cart: <b>114</b></span>
          </div>
          <ul id="selectionList"></ul>
          <div class="muted" id="constraintMsg" style="margin-top:10px; font-size:12px;"></div>
        </div>

        <div class="composite-card">
          <div class="line">
            <strong>Composite (layered PNG/WebP)</strong>
          </div>
          <div class="composite-preview" id="compositePreview">
            <div class="composite-empty" id="compositeEmpty">No images for current selections.</div>
          </div>
          <div class="composite-actions">
            <button id="btnDownloadCompositeWhite" class="primary">Download composite (white bg)</button>
            <button id="btnDownloadCompositeTransparent">Download composite (transparent)</button>
          </div>
          <div class="line" style="margin-top:4px;">
            <strong>Image layers</strong>
          </div>
          <div class="layers-list" id="imageLayersList"></div>
        </div>

        <div class="muted" style="font-size:12px; line-height:1.35">
          If “Order” fails with a message about missing option/variant, it means Product 114 needs a
          <b>variantId</b> or <b>optionSelections</b> to be added to cart.
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>
  <iframe name="hiddenCartFrame" style="display:none;"></iframe>

  <div class="admin-overlay" id="adminPrompt">
    <div class="admin-modal">
      <h3>Admin access</h3>
      <label>Password
        <input id="adminPassword" type="password" placeholder="Enter password" />
      </label>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <button id="adminCancel">Cancel</button>
        <button id="adminSubmit" class="primary">Enter</button>
      </div>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel">
    <div class="admin-header">
      <div>
        <strong>Admin Panel</strong>
        <div class="status-line" id="adminStatusLine"></div>
        <div class="status-line" id="adminSizeLine"></div>
      </div>
      <div class="admin-actions">
        <button id="btnRefreshSheet">Refresh from Sheet</button>
        <button id="btnResetSheet">Reset to Sheet</button>
        <button id="btnResetDefaults">Reset to Defaults</button>
        <button id="btnSaveSheet" class="success">Save to Sheet</button>
        <button id="btnExitAdmin" class="danger">Logout / Exit Admin</button>
      </div>
    </div>
    <div class="admin-body">
      <label>Model to edit
        <select id="adminModelSelect"></select>
      </label>
      <div class="admin-section" id="adminGroupsSection"></div>
      <div class="admin-section" id="adminOptionsSection"></div>
    </div>
  </div>

<script>
(function(){
  // =========================
  // BIGCOMMERCE SETTINGS
  // =========================
  const PRODUCT_ID = 114;

  // Your storefront home page (redirect after add-to-cart success)
  const HOME_URL = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/";

  // =========================
  // CONFIG API SETTINGS
  // =========================
  const CONFIG_API_BASE = "https://script.google.com/macros/s/AKfycbxXozAWB_L2XQhUEVOWd36XPdtqxhHPQbVHbcTzZvcznn6MS9igoZhigt6KBkTvG-0-Qg/exec";
  const CONFIG_API_KEY = "IwillUpdatethepaswordlater";
  const CONFIG_SIZE_WARNING = 200000;

  // =========================
  // DEFAULT CONFIG (fallback)
  // =========================
  const DEFAULT_CONFIG = {
    version: 2,
    models: {
      "c-line": {
        label: "C Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "black", label: "Black", price: 0, imageUrl: "", enabled: true },
              { id: "red", label: "Red", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "1", label: "1-speed", price: 0, imageUrl: "", enabled: true },
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true },
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true },
              { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      },
      "c-line-elec": {
        label: "C Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true },
              { id: "green", label: "Green", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      },
      "p-line": {
        label: "P Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "yellow", label: "Yellow", price: 0, imageUrl: "", enabled: true },
              { id: "raw-lacquer", label: "Raw Lacquer", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "2", label: "2-speed", price: 0, imageUrl: "", enabled: true },
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "8", label: "8-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true },
              { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      },
      "p-line-elec": {
        label: "P Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true },
              { id: "line-green", label: "Line Green", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      },
      "g-line": {
        label: "G Line",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true },
              { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true },
              { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      },
      "g-line-elec": {
        label: "G Line Electric",
        groupsOrder: ["colors", "gearing", "rack", "lights"],
        groups: {
          colors: {
            label: "Color",
            required: true,
            options: [
              { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true },
              { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true },
              { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true }
            ]
          },
          gearing: {
            label: "Gearing",
            required: true,
            options: [
              { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
              { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
            ]
          },
          rack: {
            label: "Rack",
            required: true,
            options: [
              { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
            ]
          },
          lights: {
            label: "Lights",
            required: true,
            options: [
              { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
            ]
          }
        }
      }
    }
  };

  let CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));

  // =========================
  // STATE
  // =========================
  const STORAGE_KEY = "bike_configurator_b2b_v3";
  const ADMIN_STORAGE_KEY = "bike_configurator_admin_mode";
  const state = {
    modelId: "",
    selections: {},
    qty: 1,
    notes: ""
  };

  const adminState = {
    enabled: false,
    modelId: "",
    activeGroup: "",
    lastSheetUpdatedAt: "",
    lastSaveAttempt: ""
  };

  const ADMIN_PASSWORD = "Brompton";

  // =========================
  // DOM
  // =========================
  const $ = (id) => document.getElementById(id);
  const els = {
    stepsGrid: $("stepsGrid"),

    basePrice: $("basePrice"),
    optionsPrice: $("optionsPrice"),
    unitTotal: $("unitTotal"),
    qtyDisplay: $("qtyDisplay"),
    grandTotal: $("grandTotal"),

    selectionList: $("selectionList"),
    constraintMsg: $("constraintMsg"),
    compositePreview: $("compositePreview"),
    compositeEmpty: $("compositeEmpty"),
    imageLayersList: $("imageLayersList"),
    btnDownloadCompositeWhite: $("btnDownloadCompositeWhite"),
    btnDownloadCompositeTransparent: $("btnDownloadCompositeTransparent"),

    validDot: $("validDot"),
    validText: $("validText"),

    btnReset: $("btnReset"),
    btnCopyJson: $("btnCopyJson"),
    btnOrder: $("btnOrder"),
    btnAdmin: $("btnAdmin"),

    toast: $("toast"),

    adminPrompt: $("adminPrompt"),
    adminPassword: $("adminPassword"),
    adminCancel: $("adminCancel"),
    adminSubmit: $("adminSubmit"),

    adminPanel: $("adminPanel"),
    adminModelSelect: $("adminModelSelect"),
    adminGroupsSection: $("adminGroupsSection"),
    adminOptionsSection: $("adminOptionsSection"),
    adminStatusLine: $("adminStatusLine"),
    adminSizeLine: $("adminSizeLine"),
    btnRefreshSheet: $("btnRefreshSheet"),
    btnResetSheet: $("btnResetSheet"),
    btnResetDefaults: $("btnResetDefaults"),
    btnSaveSheet: $("btnSaveSheet"),
    btnExitAdmin: $("btnExitAdmin")
  };

  // =========================
  // HELPERS
  // =========================
  const ROUTE_MODEL_MAP = {
    "/c-line-configurator": "c-line",
    "/c-line-elec-configurator": "c-line-elec",
    "/g-line-configurator": "g-line",
    "/g-line-elec-configurator": "g-line-elec",
    "/p-line-configurator": "p-line",
    "/p-line-elec-configurator": "p-line-elec"
  };

  const DEFAULT_GROUP_ORDER = ["colors", "gearing", "rack", "lights"];

  function getForcedModelFromPath(){
    const rawPath = (window.location.pathname || "").toLowerCase();
    const cleaned = rawPath.replace(/\/+$/, "") || "/";
    return ROUTE_MODEL_MAP[cleaned] || "";
  }

  let forcedModelId = getForcedModelFromPath();
  let routeError = forcedModelId
    ? ""
    : "This page URL does not match a valid configurator route. Please use a supported model URL.";

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> els.toast.style.display="none", 2600);
  }

  function money(n){
    const cur = "EUR";
    try{
      return new Intl.NumberFormat(undefined, { style:"currency", currency:cur, maximumFractionDigits:0 }).format(n);
    }catch(e){
      return cur + " " + Math.round(n);
    }
  }

  function normalizeQty(v){
    const n = Number(v);
    if (!Number.isFinite(n) || n < 1) return 1;
    return Math.floor(n);
  }

  function titleCaseFromKey(key){
    return String(key || "")
      .replace(/[_-]+/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b\w/g, (m) => m.toUpperCase());
  }

  function normalizeConfig(config){
    if (!config || !config.models) return config;
    Object.values(config.models).forEach((model) => {
      if (!model) return;
      if (model.options && !model.groups){
        const order = [];
        const groups = {};
        Object.entries(model.options).forEach(([key, options]) => {
          order.push(key);
          groups[key] = {
            label: titleCaseFromKey(key),
            required: true,
            options: Array.isArray(options) ? options : []
          };
        });
        model.groupsOrder = order.length ? order : DEFAULT_GROUP_ORDER.slice();
        model.groups = groups;
        delete model.options;
      }
      if (!Array.isArray(model.groupsOrder)){
        model.groupsOrder = model.groups ? Object.keys(model.groups) : DEFAULT_GROUP_ORDER.slice();
      }
      if (!model.groups){
        model.groups = {};
      }
      model.groupsOrder.forEach((key) => {
        if (!model.groups[key]){
          model.groups[key] = {
            label: titleCaseFromKey(key),
            required: true,
            options: []
          };
        }else{
          if (!model.groups[key].label){
            model.groups[key].label = titleCaseFromKey(key);
          }
          if (typeof model.groups[key].required !== "boolean"){
            model.groups[key].required = true;
          }
          if (!Array.isArray(model.groups[key].options)){
            model.groups[key].options = [];
          }
        }
      });
    });
    return config;
  }

  function setSelectOptions(selectEl, list, placeholder){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    list.forEach(item=>{
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
      selectEl.appendChild(opt);
    });
  }

  function setSingleOption(selectEl, item){
    selectEl.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = item.id;
    opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
    selectEl.appendChild(opt);
  }

  function updatePill(pillEl, ok){
    pillEl.classList.toggle("ok", !!ok);
  }

  function metaWithFixed(label, fallback, selectEl){
    if (!label) return fallback;
    if (selectEl && selectEl.dataset.fixed === "true"){
      return `${label} (fixed for this model)`;
    }
    return label;
  }

  function getModel(modelId){
    return (CONFIG.models && CONFIG.models[modelId]) || null;
  }

  function getEnabledOptions(model, groupKey){
    if (!model || !model.groups || !model.groups[groupKey]) return [];
    const options = model.groups[groupKey].options || [];
    return options.filter(opt => opt.enabled);
  }

  function updatePreview(imgEl, option){
    if (!imgEl) return;
    if (option && option.imageUrl){
      imgEl.src = option.imageUrl;
      imgEl.style.display = "block";
    }else{
      imgEl.removeAttribute("src");
      imgEl.style.display = "none";
    }
  }

  function getCompositeGroupOrder(model){
    if (!model || !Array.isArray(model.groupsOrder)) return [];
    const order = model.groupsOrder.slice();
    if (order.includes("base")){
      return ["base", ...order.filter((key) => key !== "base")];
    }
    return order;
  }

  function getSelectedImageLayers(){
    const model = getModel(state.modelId);
    if (!model) return [];
    const order = getCompositeGroupOrder(model);
    const layers = [];
    order.forEach((groupKey) => {
      const group = model.groups[groupKey];
      if (!group) return;
      const selectedId = state.selections[groupKey] || "";
      if (!selectedId) return;
      const option = findOption(model, groupKey, selectedId);
      if (!option || !option.imageUrl) return;
      layers.push({
        groupKey,
        groupLabel: group.label || titleCaseFromKey(groupKey),
        optionId: option.id,
        optionLabel: option.label,
        imageUrl: option.imageUrl
      });
    });
    return layers;
  }

  function renderComposite(layers){
    if (!els.compositePreview) return;
    els.compositePreview.innerHTML = "";
    const empty = !layers.length;
    if (empty){
      const placeholder = document.createElement("div");
      placeholder.className = "composite-empty";
      placeholder.textContent = "No images for current selections.";
      els.compositePreview.appendChild(placeholder);
      return;
    }
    layers.forEach((layer) => {
      const img = document.createElement("img");
      img.alt = `${layer.groupLabel}: ${layer.optionLabel}`;
      img.src = layer.imageUrl;
      els.compositePreview.appendChild(img);
    });
  }

  function renderImageLayersList(layers){
    if (!els.imageLayersList) return;
    els.imageLayersList.innerHTML = "";
    if (!layers.length){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.fontSize = "12px";
      empty.textContent = "No images for current selections.";
      els.imageLayersList.appendChild(empty);
      return;
    }
    layers.forEach((layer) => {
      const item = document.createElement("div");
      item.className = "layer-item";
      item.innerHTML = `
        <img class="layer-thumb" src="${escapeHtml(layer.imageUrl)}" alt="${escapeHtml(layer.groupLabel)} thumbnail">
        <div>
          <div class="layer-title">${escapeHtml(layer.groupLabel)} — ${escapeHtml(layer.optionLabel)}</div>
          <div class="layer-meta">${escapeHtml(layer.groupKey)} / ${escapeHtml(layer.optionId)}</div>
          <div class="layer-actions">
            <button data-action="layer-open" data-url="${escapeHtml(layer.imageUrl)}">Open</button>
            <button data-action="layer-download" data-url="${escapeHtml(layer.imageUrl)}" data-label="${escapeHtml(layer.optionLabel)}">Download</button>
          </div>
        </div>
      `;
      els.imageLayersList.appendChild(item);
    });
  }

  function drawContain(ctx, img, cw, ch){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.min(cw / iw, ch / ih);
    const drawW = iw * scale;
    const drawH = ih * scale;
    const drawX = (cw - drawW) / 2;
    const drawY = (ch - drawH) / 2;
    ctx.drawImage(img, drawX, drawY, drawW, drawH);
  }

  function loadLayerImage(url){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
      img.src = url;
    });
  }

  async function exportCompositePNG(layers, opts){
    if (!layers.length){
      toast("No layers to export.");
      return;
    }
    const container = els.compositePreview;
    const width = container?.clientWidth || 700;
    const height = container?.clientHeight || 400;
    const scale = window.devicePixelRatio || 1;
    const canvas = document.createElement("canvas");
    canvas.width = Math.max(1, Math.floor(width * scale));
    canvas.height = Math.max(1, Math.floor(height * scale));
    const ctx = canvas.getContext("2d");
    if (!ctx){
      toast("Canvas not supported in this browser.");
      return;
    }
    ctx.scale(scale, scale);
    if (opts && opts.background === "white"){
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, width, height);
    }
    try{
      for (const layer of layers){
        const img = await loadLayerImage(layer.imageUrl);
        drawContain(ctx, img, width, height);
      }
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
      if (!blob){
        toast("Unable to export PNG from canvas.");
        return;
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bike-composite.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }catch(err){
      console.error(err);
      toast("Cannot export composite because some images block cross-origin canvas. Use Open/Download per layer instead.");
    }
  }

  async function downloadLayerImage(url, label){
    try{
      const res = await fetch(url, { mode: "cors", credentials: "omit" });
      if (!res.ok){
        throw new Error("Failed download");
      }
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = `${(label || "layer").replace(/\s+/g, "-").toLowerCase()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(blobUrl);
    }catch(err){
      window.open(url, "_blank", "noopener");
      toast("Download blocked by CORS; opened image instead.");
    }
  }

  function ensureSelection(model, groupKey, selection){
    const enabled = getEnabledOptions(model, groupKey);
    if (!enabled.length){
      return { value: "", fixed: true, enabled, selected: null, disabled: true };
    }
    const isFixed = enabled.length === 1;
    let nextValue = selection || "";
    if (isFixed){
      nextValue = enabled[0].id;
    }else if (nextValue && !enabled.some(opt => opt.id === nextValue)){
      nextValue = "";
    }
    const selected = enabled.find(opt => opt.id === nextValue) || null;
    return { value: nextValue, fixed: isFixed, enabled, selected, disabled: isFixed };
  }

  function buildOptionOptions(options, selectedValue, placeholder, allowEmpty){
    const parts = [];
    const placeholderLabel = placeholder || "Select option…";
    if (allowEmpty){
      parts.push(`<option value="">${escapeHtml(placeholderLabel)}</option>`);
    }
    options.forEach(opt => {
      const priceLabel = opt.price ? ` (+${money(opt.price)})` : "";
      const selected = opt.id === selectedValue ? "selected" : "";
      parts.push(`<option value="${escapeHtml(opt.id)}" ${selected}>${escapeHtml(opt.label)}${priceLabel}</option>`);
    });
    if (!allowEmpty && !options.length){
      parts.push(`<option value="">Unavailable</option>`);
    }
    return parts.join("");
  }

  function validateAndApplyConstraints(){
    if (routeError){
      state.modelId = "";
      state.selections = {};
      return { ok:false, msg:routeError, model:null, routeError:true, groups: [] };
    }

    const model = getModel(forcedModelId);
    if (!model){
      return { ok:false, msg:"Unsupported model route. Please use a valid configurator URL.", model:null, routeError:true, groups: [] };
    }

    state.modelId = forcedModelId;
    const groupKeys = model.groupsOrder || [];
    const groupStates = [];
    let changed = false;
    groupKeys.forEach((key) => {
      const group = model.groups[key] || { label: titleCaseFromKey(key), required: true, options: [] };
      const selection = state.selections[key] || "";
      const ensured = ensureSelection(model, key, selection);
      if (ensured.value !== selection){
        state.selections[key] = ensured.value;
        changed = true;
      }
      const required = group.required !== false;
      const isComplete = required ? !!ensured.value : true;
      groupStates.push({
        key,
        group,
        enabled: ensured.enabled,
        selectedId: ensured.value,
        selectedOption: ensured.selected,
        fixed: ensured.fixed,
        disabled: ensured.disabled,
        required,
        isComplete
      });
    });
    if (changed){
      saveState();
    }
    const missing = groupStates.filter(item => item.required && !item.selectedId)
      .map(item => item.group.label || titleCaseFromKey(item.key));
    if (missing.length){
      return { ok:false, msg:`Missing: ${missing.join(", ")}.`, model, groups: groupStates };
    }
    return { ok:true, msg:"Ready to order.", model, groups: groupStates };
  }

  function buildAttribute116Value(){
    const model = getModel(state.modelId);
    const missing = [];
    const parts = [];
    if (!model || !model.label){
      missing.push("Model");
    }else{
      parts.push(`Model: ${model.label}`);
    }
    if (model){
      (model.groupsOrder || []).forEach((key) => {
        const group = model.groups[key];
        if (!group) return;
        const selectedId = state.selections[key] || "";
        if (!selectedId){
          if (group.required !== false){
            missing.push(group.label || titleCaseFromKey(key));
          }
          return;
        }
        const option = findOption(model, key, selectedId);
        if (!option) return;
        const priceTag = option.price ? ` (+${money(option.price)})` : "";
        parts.push(`${group.label || titleCaseFromKey(key)}: ${option.label}${priceTag}`);
      });
    }

    if (missing.length){
      return { missing, value: "" };
    }
    const qtyValue = normalizeQty(state.qty);
    const notesValue = (state.notes || "").trim();
    parts.push(`Qty: ${qtyValue}`);
    parts.push(`Notes: ${notesValue || "(none)"}`);
    return { missing, value: parts.join("\n") };
  }

  function findOption(model, groupKey, id){
    if (!model || !model.groups || !model.groups[groupKey]) return null;
    return (model.groups[groupKey].options || []).find(opt => opt.id === id) || null;
  }

  function findOptionLabel(model, groupKey, id){
    const option = findOption(model, groupKey, id);
    return option ? option.label : "";
  }

  function calc(){
    const model = getModel(state.modelId);
    const base = 0;
    let optionsTotal = 0;
    if (model){
      (model.groupsOrder || []).forEach((key) => {
        const selectedId = state.selections[key];
        if (!selectedId) return;
        const option = findOption(model, key, selectedId);
        if (option && option.price){
          optionsTotal += option.price;
        }
      });
    }

    const unit = base + optionsTotal;
    const qty = normalizeQty(state.qty);
    const total = unit * qty;

    return { base, options: optionsTotal, unit, qty, total, model };
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj) return;
      state.modelId = obj.modelId || "";
      if (obj.selections && typeof obj.selections === "object"){
        state.selections = { ...obj.selections };
      }else{
        state.selections = {
          colors: obj.colorId || "",
          gearing: obj.gearingId || "",
          rack: obj.rackId || "",
          lights: obj.lightsId || ""
        };
      }
      state.qty = normalizeQty(obj.qty || 1);
      state.notes = obj.notes || "";
      if (forcedModelId){
        if (state.modelId !== forcedModelId){
          state.selections = {};
        }
        state.modelId = forcedModelId;
      }else{
        state.modelId = "";
        state.selections = {};
      }
    }catch(e){}
  }

  function loadAdminState(){
    try{
      const raw = localStorage.getItem(ADMIN_STORAGE_KEY);
      adminState.enabled = raw === "true";
    }catch(e){
      adminState.enabled = false;
    }
  }

  function saveAdminState(){
    try{
      localStorage.setItem(ADMIN_STORAGE_KEY, adminState.enabled ? "true" : "false");
    }catch(e){}
  }

  function exportConfig(){
    return JSON.stringify(CONFIG, null, 2);
  }

  function getConfigSize(){
    try{
      return JSON.stringify(CONFIG).length;
    }catch(e){
      return 0;
    }
  }

  function updateAdminStatus(){
    const updatedAt = adminState.lastSheetUpdatedAt ? `Sheet updated: ${adminState.lastSheetUpdatedAt}` : "Sheet updated: —";
    const lastSave = adminState.lastSaveAttempt ? `Last save attempt: ${adminState.lastSaveAttempt}` : "Last save attempt: —";
    els.adminStatusLine.textContent = `${updatedAt} | ${lastSave}`;
    const size = getConfigSize();
    const warning = size > CONFIG_SIZE_WARNING;
    els.adminSizeLine.textContent = `Config size: ${size} chars${warning ? " (warning: large config)" : ""}`;
    els.adminSizeLine.classList.toggle("warn", warning);
  }

  function reconcileSelections(){
    let changed = false;
    const model = getModel(forcedModelId);
    if (!model){
      if (state.modelId || Object.keys(state.selections || {}).length){
        changed = true;
      }
      state.modelId = "";
      state.selections = {};
    }else{
      state.modelId = forcedModelId;
      const nextSelections = {};
      (model.groupsOrder || []).forEach((key) => {
        const enabledOptions = getEnabledOptions(model, key);
        const selectedId = state.selections[key] || "";
        if (selectedId && enabledOptions.some(opt => opt.id === selectedId)){
          nextSelections[key] = selectedId;
        }else if (enabledOptions.length === 1){
          nextSelections[key] = enabledOptions[0].id;
          if (state.selections[key] !== nextSelections[key]) changed = true;
        }else if (state.selections[key]){
          changed = true;
        }
      });
      const removedSelections = Object.keys(state.selections || {}).filter((key) => !(model.groupsOrder || []).includes(key));
      if (removedSelections.length){
        changed = true;
      }
      state.selections = nextSelections;
    }
    if (changed){
      saveState();
    }
  }

  async function fetchConfigFromSheet(){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    let responseText = "";
    const res = await fetch(url, {
      method: "GET",
      cache: "no-store",
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Config response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true || !json.data){
      const message = json && json.error ? json.error : "Config response missing ok/data.";
      const apiError = new Error(message);
      apiError.responseText = responseText;
      throw apiError;
    }
    adminState.lastSheetUpdatedAt = json.meta && json.meta.updated_at ? json.meta.updated_at : "";
    updateAdminStatus();
    return json.data;
  }

  async function saveConfigToSheet(configObj){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    const body = new URLSearchParams();
    body.set("payload", JSON.stringify(configObj));
    body.set("key", CONFIG_API_KEY);
    let responseText = "";
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString(),
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Save response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true){
      const message = json && json.error ? json.error : responseText;
      const apiError = new Error(message || "Save failed.");
      apiError.responseText = responseText;
      throw apiError;
    }
    return json;
  }

  async function loadConfigFromSheet(useFallbackOnError){
    try{
      CONFIG = normalizeConfig(await fetchConfigFromSheet());
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config loaded from sheet.");
      return true;
    }catch(err){
      console.error("Failed to load config from sheet.", err, err && err.responseText ? err.responseText : "");
      if (useFallbackOnError){
        CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));
        reconcileSelections();
        renderBuyer();
        renderAdmin();
        toast("Using local defaults (config API unavailable)");
      }else{
        const message = err && err.message ? err.message : "Unknown error";
        toast(`Failed to load sheet config: ${message}`);
      }
      return false;
    }
  }

  async function saveConfigFlow(){
    const errors = validateConfig(CONFIG);
    if (errors.length){
      toast("Fix validation errors before saving:\n" + errors.join("\n"));
      return false;
    }
    adminState.lastSaveAttempt = new Date().toLocaleString();
    updateAdminStatus();
    try{
      await saveConfigToSheet(CONFIG);
      toast("Saved to Sheet");
      renderBuyer();
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to save config to sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to save to Sheet: ${message}`);
      return false;
    }
  }

  function validateConfig(config){
    const errors = [];
    if (!config || !config.models){
      errors.push("Config models missing.");
      return errors;
    }
    Object.entries(config.models).forEach(([modelId, model]) => {
      if (!model.groups || !Array.isArray(model.groupsOrder)){
        errors.push(`${modelId} groups/groupsOrder missing.`);
        return;
      }
      const orderSet = new Set();
      model.groupsOrder.forEach((key) => {
        if (!/^[a-z0-9_-]+$/.test(key)){
          errors.push(`${modelId} group key "${key}" must be lowercase letters, numbers, dashes, or underscores.`);
        }
        if (orderSet.has(key)){
          errors.push(`${modelId} group key "${key}" appears multiple times in order.`);
        }
        orderSet.add(key);
        const group = model.groups[key];
        if (!group){
          errors.push(`${modelId} group "${key}" missing from groups.`);
          return;
        }
        if (!group.label){
          errors.push(`${modelId} group "${key}": label is required.`);
        }
        if (typeof group.required !== "boolean"){
          errors.push(`${modelId} group "${key}": required must be true/false.`);
        }
        const options = Array.isArray(group.options) ? group.options : [];
        const seen = new Set();
        options.forEach((opt, index) => {
          if (!opt.id){
            errors.push(`${modelId} ${group.label || key} option #${index + 1}: id is required.`);
          }else if (seen.has(opt.id)){
            errors.push(`${modelId} ${group.label || key} option id "${opt.id}" is duplicated.`);
          }else{
            seen.add(opt.id);
          }
          if (opt.imageUrl && !/^https?:\/\//i.test(opt.imageUrl)){
            errors.push(`${modelId} ${group.label || key} option "${opt.id}": imageUrl must start with http:// or https://`);
          }
          const price = Number(opt.price);
          if (!Number.isFinite(price) || price < 0){
            errors.push(`${modelId} ${group.label || key} option "${opt.id}": price must be a number >= 0`);
          }
        });
      });
    });
    return errors;
  }

  function renderBuyer(){
    const v = validateAndApplyConstraints();
    const c = calc();

    els.constraintMsg.textContent = v.msg || "";

    els.basePrice.textContent = c.model ? money(c.base) : "—";
    els.optionsPrice.textContent = c.model ? money(c.options) : "—";
    els.unitTotal.textContent = c.model ? money(c.unit) : "—";
    els.qtyDisplay.textContent = String(c.qty);
    els.grandTotal.textContent = c.model ? money(c.total) : "—";

    if (v.ok){
      els.validDot.className = "dot ok";
      els.validText.textContent = "Ready";
    }else{
      els.validDot.className = "dot bad";
      els.validText.textContent = "Incomplete";
    }
    els.btnOrder.disabled = !v.ok;

    const steps = [];
    let stepNumber = 1;
    const modelLabel = v.model ? v.model.label : "";
    const modelMeta = modelLabel ? modelLabel : "Choose a base model";
    steps.push(`
      <div class="step">
        <div class="shd">
          <span class="pill ok">${stepNumber}</span>
          <div style="flex:1">
            <div class="name">Model</div>
            <div class="meta">${escapeHtml(modelMeta)}</div>
          </div>
          <div class="meta">—</div>
        </div>
        <div class="sbd">
          <label>Model
            <select data-role="model" disabled>
              ${v.model ? `<option value="${escapeHtml(state.modelId)}">${escapeHtml(v.model.label)}</option>` : `<option value="">Invalid route</option>`}
            </select>
          </label>
        </div>
      </div>
    `);
    stepNumber += 1;

    (v.groups || []).forEach((groupState) => {
      const group = groupState.group;
      const label = group.label || titleCaseFromKey(groupState.key);
      const selected = groupState.selectedOption;
      const metaText = selected ? selected.label : (groupState.required ? `Select ${label.toLowerCase()}` : "Optional");
      const priceText = selected ? (selected.price ? `+${money(selected.price)}` : money(0)) : "—";
      const showOk = groupState.isComplete;
      const selectOptions = buildOptionOptions(groupState.enabled, groupState.selectedId, `Select ${label.toLowerCase()}…`, !groupState.fixed);
      const fixedAttr = groupState.fixed ? "data-fixed=\"true\"" : "data-fixed=\"false\"";
      const disabledAttr = groupState.disabled ? "disabled" : "";
      const previewId = `preview-${groupState.key}`;
      steps.push(`
        <div class="step">
          <div class="shd">
            <span class="pill ${showOk ? "ok" : ""}">${stepNumber}</span>
            <div style="flex:1">
              <div class="name">${escapeHtml(label)}</div>
              <div class="meta">${escapeHtml(metaWithFixed(selected ? selected.label : "", metaText, { dataset: { fixed: groupState.fixed ? "true" : "false" } }))}</div>
            </div>
            <div class="meta">${escapeHtml(priceText)}</div>
          </div>
          <div class="sbd">
            <label>${escapeHtml(label)}
              <select data-group="${escapeHtml(groupState.key)}" ${fixedAttr} ${disabledAttr}>
                ${selectOptions}
              </select>
            </label>
            <img id="${previewId}" class="option-preview" alt="Selected ${escapeHtml(label)} preview" />
          </div>
        </div>
      `);
      stepNumber += 1;
    });

    steps.push(`
      <div class="step">
        <div class="shd">
          <span class="pill ok">${stepNumber}</span>
          <div style="flex:1">
            <div class="name">Quantity</div>
            <div class="meta">How many bikes</div>
          </div>
          <div class="meta">—</div>
        </div>
        <div class="sbd">
          <label>Qty
            <input id="qtyInput" type="number" min="1" step="1" value="${escapeHtml(String(state.qty))}" />
          </label>
          <label style="margin-top:10px;">Notes (optional)
            <textarea id="notesInput" rows="3" placeholder="Internal notes...">${escapeHtml(state.notes || "")}</textarea>
          </label>
        </div>
      </div>
    `);

    els.stepsGrid.innerHTML = steps.join("");

    (v.groups || []).forEach((groupState) => {
      const previewEl = document.getElementById(`preview-${groupState.key}`);
      updatePreview(previewEl, groupState.selectedOption);
    });

    els.selectionList.innerHTML = "";
    const addLi = (label, val) => {
      const li = document.createElement("li");
      li.innerHTML = `<span class="muted">${escapeHtml(label)}:</span> ${escapeHtml(val)}`;
      els.selectionList.appendChild(li);
    };
    if (c.model) addLi("Model", c.model.label);
    (v.groups || []).forEach((groupState) => {
      if (groupState.selectedOption){
        addLi(groupState.group.label || titleCaseFromKey(groupState.key), groupState.selectedOption.label);
      }
    });
    addLi("Qty", String(c.qty));
    if (state.notes && state.notes.trim()) addLi("Notes", state.notes.trim());

    const layers = getSelectedImageLayers();
    renderComposite(layers);
    renderImageLayersList(layers);

    saveState();
  }

  function renderAdmin(){
    if (!adminState.enabled){
      els.adminPanel.style.display = "none";
      return;
    }
    const modelIds = Object.keys(CONFIG.models || {});
    if (!adminState.modelId || !CONFIG.models[adminState.modelId]){
      adminState.modelId = modelIds[0] || "";
    }
    els.adminPanel.style.display = "flex";

    els.adminModelSelect.innerHTML = "";
    modelIds.forEach(id => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = CONFIG.models[id].label || id;
      els.adminModelSelect.appendChild(opt);
    });
    els.adminModelSelect.value = adminState.modelId;

    const model = CONFIG.models[adminState.modelId];
    const groupsOrder = model.groupsOrder || [];
    const groups = model.groups || {};
    if (!adminState.activeGroup || !groupsOrder.includes(adminState.activeGroup)){
      adminState.activeGroup = groupsOrder[0] || "";
    }

    els.adminGroupsSection.innerHTML = `
      <div class="line" style="margin-bottom:8px;">
        <strong>Option Groups</strong>
      </div>
      <div class="admin-help" style="margin-bottom:10px;">Manage group order, labels, and required flags.</div>
      ${groupsOrder.map((key, index) => {
        const group = groups[key] || { label: titleCaseFromKey(key), required: true };
        return `
          <div class="admin-group-row" data-group="${escapeHtml(key)}">
            <label>Group key
              <input type="text" value="${escapeHtml(key)}" data-field="groupKey" disabled>
            </label>
            <label>Label
              <input type="text" value="${escapeHtml(group.label || "")}" data-field="groupLabel">
            </label>
            <label>Required
              <input type="checkbox" data-field="groupRequired" ${group.required !== false ? "checked" : ""}>
            </label>
            <div class="admin-row-actions">
              <button data-action="group-move-up" ${index === 0 ? "disabled" : ""}>Up</button>
              <button data-action="group-move-down" ${index === groupsOrder.length - 1 ? "disabled" : ""}>Down</button>
              <button data-action="group-delete" class="danger">Delete</button>
            </div>
          </div>
        `;
      }).join("")}
      <div class="hr" style="margin:10px 0;"></div>
      <div class="admin-inline">
        <label class="small">Group key
          <input id="adminNewGroupKey" type="text" placeholder="saddle">
        </label>
        <label>Group label
          <input id="adminNewGroupLabel" type="text" placeholder="Saddle">
        </label>
        <label class="small">Required
          <input id="adminNewGroupRequired" type="checkbox" checked>
        </label>
        <button class="primary" data-action="group-add">Add Group</button>
      </div>
      <div class="admin-help">Key must be lowercase letters, numbers, dashes, or underscores. Example: saddle.</div>
    `;

    const activeGroup = adminState.activeGroup;
    const activeOptions = activeGroup ? (groups[activeGroup]?.options || []) : [];
    els.adminOptionsSection.innerHTML = `
      <div class="line" style="margin-bottom:8px;">
        <strong>Options Editor</strong>
        ${activeGroup ? `<button class="primary" data-action="option-add" data-group="${escapeHtml(activeGroup)}">Add option</button>` : ""}
      </div>
      <div class="admin-inline" style="margin-bottom:10px;">
        <label>Edit group
          <select id="adminGroupSelect">
            ${groupsOrder.map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(groups[key]?.label || titleCaseFromKey(key))}</option>`).join("")}
          </select>
        </label>
      </div>
      ${activeGroup ? `
        <table class="admin-table">
          <thead>
            <tr>
              <th style="width:120px;">ID</th>
              <th>Label</th>
              <th style="width:90px;">Price</th>
              <th>Image URL</th>
              <th style="width:80px;">Enabled</th>
              <th style="width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${activeOptions.map((opt, index) => `
              <tr data-index="${index}" data-group="${escapeHtml(activeGroup)}">
                <td><input type="text" value="${escapeHtml(opt.id)}" data-field="id"></td>
                <td><input type="text" value="${escapeHtml(opt.label)}" data-field="label"></td>
                <td><input type="number" min="0" step="1" value="${Number.isFinite(opt.price) ? opt.price : 0}" data-field="price"></td>
                <td><input type="text" value="${escapeHtml(opt.imageUrl || "")}" data-field="imageUrl"></td>
                <td style="text-align:center;"><input type="checkbox" ${opt.enabled ? "checked" : ""} data-field="enabled"></td>
                <td>
                  <div class="admin-row-actions">
                    <button data-action="option-move-up" ${index === 0 ? "disabled" : ""}>Up</button>
                    <button data-action="option-move-down" ${index === activeOptions.length - 1 ? "disabled" : ""}>Down</button>
                    <button data-action="option-delete" class="danger">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="admin-help">Add a group to start editing options.</div>`}
    `;

    const adminGroupSelect = document.getElementById("adminGroupSelect");
    if (adminGroupSelect){
      adminGroupSelect.value = activeGroup;
    }
    updateAdminStatus();
  }

  function escapeHtml(str){
    return String(str || "").replace(/[&<>"]+/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;"
    }[m] || m));
  }

  // =========================
  // BIGCOMMERCE CART HELPERS
  // =========================
  function submitCartForm(qty, attribute116Value){
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/cart.php";
    form.target = "hiddenCartFrame";

    const addInput = (name, value) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = value;
      form.appendChild(input);
    };

    addInput("action", "add");
    addInput("product_id", String(PRODUCT_ID));
    addInput("qty[]", String(qty));
    addInput("attribute[116]", attribute116Value);

    document.body.appendChild(form);
    form.submit();
    form.remove();
  }

  // =========================
  // ADMIN HELPERS
  // =========================
  function openAdminPrompt(){
    els.adminPrompt.style.display = "flex";
    els.adminPassword.value = "";
    els.adminPassword.focus();
  }

  function closeAdminPrompt(){
    els.adminPrompt.style.display = "none";
  }

  function enableAdminMode(){
    adminState.enabled = true;
    saveAdminState();
    toast("Admin mode enabled");
    renderAdmin();
  }

  function disableAdminMode(){
    adminState.enabled = false;
    saveAdminState();
    els.adminPanel.style.display = "none";
    toast("Admin mode disabled");
  }

  // =========================
  // EVENTS
  // =========================
  els.stepsGrid.addEventListener("change", (e)=>{
    const select = e.target.closest("select");
    if (!select) return;
    const groupKey = select.dataset.group;
    if (groupKey){
      state.selections[groupKey] = select.value;
      renderBuyer();
    }
  });

  els.stepsGrid.addEventListener("input", (e)=>{
    const target = e.target;
    if (target && target.id === "qtyInput"){
      state.qty = normalizeQty(target.value);
      renderBuyer();
    }
    if (target && target.id === "notesInput"){
      state.notes = target.value || "";
      renderBuyer();
    }
  });

  els.btnReset.addEventListener("click", ()=>{
    state.modelId = "";
    state.selections = {};
    state.qty = 1;
    state.notes = "";
    renderBuyer();
    toast("Reset complete.");
  });

  els.btnCopyJson.addEventListener("click", async ()=>{
    const txt = exportConfig();
    try{
      await navigator.clipboard.writeText(txt);
      toast("Config JSON copied.");
    }catch(e){
      prompt("Copy JSON:", txt);
    }
  });

  els.btnOrder.addEventListener("click", ()=>{
    const attributeResult = buildAttribute116Value();
    if (attributeResult.missing.length){
      const message = `Please complete: ${attributeResult.missing.join(", ")}`;
      toast("Complete required selections before ordering.");
      alert(message);
      return;
    }

    const qty = normalizeQty(state.qty);

    els.btnOrder.disabled = true;
    els.btnOrder.textContent = "Ordering…";

    submitCartForm(qty, attributeResult.value);
    toast("Added to cart. Returning home…");
    setTimeout(() => {
      window.location.href = HOME_URL;
    }, 700);
  });

  els.btnDownloadCompositeWhite.addEventListener("click", ()=>{
    const layers = getSelectedImageLayers();
    exportCompositePNG(layers, { background: "white" });
  });

  els.btnDownloadCompositeTransparent.addEventListener("click", ()=>{
    const layers = getSelectedImageLayers();
    exportCompositePNG(layers, { background: "transparent" });
  });

  els.imageLayersList.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const action = btn.dataset.action;
    const url = btn.dataset.url;
    if (!url) return;
    if (action === "layer-open"){
      window.open(url, "_blank", "noopener");
    }
    if (action === "layer-download"){
      downloadLayerImage(url, btn.dataset.label || "");
    }
  });

  els.btnAdmin.addEventListener("click", ()=>{
    if (adminState.enabled){
      renderAdmin();
      return;
    }
    openAdminPrompt();
  });

  els.adminCancel.addEventListener("click", ()=>{
    closeAdminPrompt();
  });

  els.adminSubmit.addEventListener("click", ()=>{
    const value = els.adminPassword.value || "";
    if (value === ADMIN_PASSWORD){
      closeAdminPrompt();
      enableAdminMode();
    }else{
      toast("Wrong password");
    }
  });

  els.adminPassword.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){
      els.adminSubmit.click();
    }
  });

  els.btnExitAdmin.addEventListener("click", ()=>{
    disableAdminMode();
  });

  async function refreshConfigFromSheet(){
    try{
      CONFIG = normalizeConfig(await fetchConfigFromSheet());
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config refreshed from sheet.");
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to refresh config from sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to refresh from Sheet: ${message}`);
      return false;
    }
  }

  els.btnRefreshSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetDefaults.addEventListener("click", ()=>{
    CONFIG = normalizeConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG)));
    reconcileSelections();
    renderBuyer();
    renderAdmin();
    toast("Reset to local defaults.");
  });

  els.btnSaveSheet.addEventListener("click", ()=>{
    saveConfigFlow();
  });

  els.adminModelSelect.addEventListener("change", (e)=>{
    adminState.modelId = e.target.value;
    renderAdmin();
  });

  els.adminGroupsSection.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const model = CONFIG.models[adminState.modelId];
    if (!model) return;
    if (action === "group-add"){
      const keyInput = document.getElementById("adminNewGroupKey");
      const labelInput = document.getElementById("adminNewGroupLabel");
      const requiredInput = document.getElementById("adminNewGroupRequired");
      const key = (keyInput?.value || "").trim();
      const label = (labelInput?.value || "").trim();
      const required = requiredInput ? requiredInput.checked : true;
      if (!/^[a-z0-9_-]+$/.test(key)){
        toast("Group key must be lowercase letters, numbers, dashes, or underscores.");
        return;
      }
      if (model.groups && model.groups[key]){
        toast(`Group key "${key}" already exists.`);
        return;
      }
      if (!label){
        toast("Group label is required.");
        return;
      }
      model.groups = model.groups || {};
      model.groups[key] = {
        label,
        required,
        options: []
      };
      model.groupsOrder = model.groupsOrder || [];
      model.groupsOrder.push(key);
      adminState.activeGroup = key;
      renderBuyer();
      renderAdmin();
      return;
    }
    const row = actionBtn.closest(".admin-group-row");
    const groupKey = row ? row.dataset.group : "";
    if (!groupKey) return;
    if (action === "group-delete"){
      model.groupsOrder = (model.groupsOrder || []).filter((key) => key !== groupKey);
      if (model.groups){
        delete model.groups[groupKey];
      }
      if (state.selections && state.selections[groupKey]){
        delete state.selections[groupKey];
      }
      if (adminState.activeGroup === groupKey){
        adminState.activeGroup = model.groupsOrder[0] || "";
      }
      renderBuyer();
      renderAdmin();
      return;
    }
    const index = model.groupsOrder.indexOf(groupKey);
    if (action === "group-move-up" && index > 0){
      [model.groupsOrder[index - 1], model.groupsOrder[index]] = [model.groupsOrder[index], model.groupsOrder[index - 1]];
    }
    if (action === "group-move-down" && index < model.groupsOrder.length - 1){
      [model.groupsOrder[index + 1], model.groupsOrder[index]] = [model.groupsOrder[index], model.groupsOrder[index + 1]];
    }
    renderBuyer();
    renderAdmin();
  });

  els.adminGroupsSection.addEventListener("input", (e)=>{
    const input = e.target;
    const row = input.closest(".admin-group-row");
    if (!row) return;
    const groupKey = row.dataset.group;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[groupKey]) return;
    const group = model.groups[groupKey];
    const field = input.dataset.field;
    if (field === "groupLabel"){
      group.label = input.value.trim();
    }
    if (field === "groupRequired"){
      group.required = input.checked;
    }
    updateAdminStatus();
    renderBuyer();
  });

  els.adminOptionsSection.addEventListener("change", (e)=>{
    const select = e.target;
    if (select && select.id === "adminGroupSelect"){
      adminState.activeGroup = select.value;
      renderAdmin();
    }
  });

  els.adminOptionsSection.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const group = actionBtn.dataset.group || actionBtn.closest("tr")?.dataset.group;
    if (!group) return;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[group]) return;
    const options = model.groups[group].options || [];
    if (action === "option-add"){
      options.push({
        id: `new-${Date.now()}`,
        label: "",
        price: 0,
        imageUrl: "",
        enabled: true
      });
      renderBuyer();
      renderAdmin();
      return;
    }
    const row = actionBtn.closest("tr");
    const index = row ? Number(row.dataset.index) : -1;
    if (index < 0) return;
    if (action === "option-delete"){
      options.splice(index, 1);
    }
    if (action === "option-move-up" && index > 0){
      [options[index - 1], options[index]] = [options[index], options[index - 1]];
    }
    if (action === "option-move-down" && index < options.length - 1){
      [options[index + 1], options[index]] = [options[index], options[index + 1]];
    }
    renderBuyer();
    renderAdmin();
  });

  els.adminOptionsSection.addEventListener("input", (e)=>{
    const input = e.target;
    const row = input.closest("tr");
    if (!row) return;
    const group = row.dataset.group;
    const index = Number(row.dataset.index);
    const field = input.dataset.field;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.groups || !model.groups[group] || !model.groups[group].options[index]) return;
    const option = model.groups[group].options[index];
    if (field === "enabled"){
      option.enabled = input.checked;
    }else if (field === "price"){
      option.price = Number(input.value);
    }else if (field === "id"){
      option.id = input.value.trim();
    }else if (field === "label"){
      option.label = input.value;
    }else if (field === "imageUrl"){
      option.imageUrl = input.value.trim();
    }
    updateAdminStatus();
    renderBuyer();
  });

  // =========================
  // INIT
  // =========================
  loadState();
  loadAdminState();
  renderBuyer();
  if (routeError){
    toast(routeError);
  }
  if (adminState.enabled){
    renderAdmin();
  }
  loadConfigFromSheet(true);
})();
</script>
</body>
</html>
