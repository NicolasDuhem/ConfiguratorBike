<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bike Configurator (HTML Only)</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --text:#101218;
      --muted:#5b6475;
      --accent:#1f4bff;
      --ok:#1f9d67;
      --bad:#d64550;
      --border:rgba(16,18,24,.12);
      --shadow: 0 12px 30px rgba(15,23,42,.12);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 40px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 18px;
    }
    header{
      grid-column: 1 / -1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    .title{display:flex; flex-direction:column; gap:6px}
    h1{margin:0; font-size: 22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; line-height:1.4}

    .top-actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button{
      appearance:none; border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      box-shadow: 0 6px 16px rgba(15,23,42,.08);
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{border-color: rgba(31,75,255,.35)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(31,75,255,.35);
      background: rgba(31,75,255,.08);
    }
    button.success{
      border-color: rgba(31,157,103,.35);
      background: rgba(31,157,103,.10);
    }
    button.danger{
      border-color: rgba(214,69,80,.35);
      background: rgba(214,69,80,.08);
    }

    .panel{
      background: #fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hd .h2{font-weight: 800; font-size: 14px; letter-spacing:.2px}
    .panel .bd{padding: 14px}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      .grid{grid-template-columns:1fr}
    }

    .step{
      border:1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      overflow:hidden;
    }
    .step .shd{
      padding: 12px 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: #fafbff;
      border-bottom: 1px solid var(--border);
    }
    .pill{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(31,75,255,.12);
      border:1px solid rgba(31,75,255,.25);
      color: #1f2d6a;
    }
    .pill.ok{
      background: rgba(31,157,103,.12);
      border-color: rgba(31,157,103,.25);
      color:#0f5b3c;
    }
    .step .shd .name{font-weight: 800; font-size: 13px}
    .step .shd .meta{font-size:12px; color: var(--muted)}
    .step .sbd{padding: 12px}

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    select, input[type="number"], textarea, input[type="text"], input[type="password"]{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-weight:700;
    }
    select:disabled, input:disabled, textarea:disabled{
      background: #f0f2f6;
      color: #7c8597;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(31,75,255,.5);
      box-shadow: 0 0 0 3px rgba(31,75,255,.12);
    }

    .summary{display:flex; flex-direction:column; gap:12px}
    .totals{
      display:flex; flex-direction:column; gap:8px;
      padding: 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .line{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 13px}
    .line strong{font-size: 14px}
    .hr{height:1px; background: var(--border); margin:6px 0}
    .items{
      padding: 12px;
      background: #f7f8fb;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    .items ul{margin:0; padding-left: 18px}
    .items li{margin:6px 0; color:#1d2435}
    .muted{color:var(--muted)}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:800;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      width: fit-content;
    }
    .dot{width:10px; height:10px; border-radius: 999px; background: rgba(16,18,24,.3)}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 13px;
      display:none;
      max-width: 420px;
      z-index: 999;
      white-space: pre-wrap;
    }

    .option-preview{
      margin-top: 8px;
      max-height: 120px;
      width: 100%;
      object-fit: contain;
      border: 1px solid rgba(16,18,24,.12);
      border-radius: 12px;
      display:none;
      background:#fff;
    }

    .admin-overlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
    }
    .admin-modal{
      background:#fff;
      border-radius: 16px;
      padding: 18px;
      width: min(420px, 90vw);
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    .admin-modal h3{margin:0 0 10px; font-size:16px}
    .admin-panel{
      position: fixed;
      inset: auto 12px 12px 12px;
      background:#fff;
      border-radius: 16px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      max-height: 80vh;
      display:none;
      flex-direction:column;
      z-index: 998;
    }
    .admin-panel .admin-header{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: #f9faff;
      flex-wrap:wrap;
    }
    .admin-panel .admin-body{
      padding: 14px;
      overflow:auto;
      display:grid;
      gap: 12px;
    }
    .admin-actions{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .admin-tabs button{padding:6px 10px; font-size:12px}
    .admin-tabs button.active{border-color: rgba(31,75,255,.6); background: rgba(31,75,255,.12)}
    .admin-section{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #fafbff;
    }
    .admin-table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .admin-table th,
    .admin-table td{
      border-bottom:1px solid var(--border);
      padding: 6px;
      text-align:left;
      vertical-align:top;
    }
    .admin-table th{color: var(--muted); font-weight:700}
    .admin-row-actions{display:flex; gap:6px; flex-wrap:wrap}
    .admin-row-actions button{padding:6px 8px; font-size:11px}
    .status-line{font-size:12px; color: var(--muted)}
    .status-line.warn{color: var(--bad); font-weight: 800}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Bike Configurator</h1>
        <div class="sub">
          HTML-only. Click <b>Order</b> to add Product <b>#114</b> to cart and return to home.
        </div>
      </div>

      <div class="top-actions">
        <button id="btnAdmin" class="primary">ADMIN</button>
        <button id="btnReset">Reset</button>
        <button id="btnCopyJson">Copy JSON</button>
        <button id="btnOrder" class="success">Order (Add to Cart)</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="panel">
      <div class="hd">
        <div class="h2">Build your bike</div>
        <div class="muted" style="font-size:12px">
          Adds to cart via Storefront Cart API.
        </div>
      </div>
      <div class="bd">
        <div class="grid">
          <div class="step">
            <div class="shd">
              <span class="pill" id="pill-model">1</span>
              <div style="flex:1">
                <div class="name">Model</div>
                <div class="meta" id="meta-model">Choose a base model</div>
              </div>
              <div class="meta" id="price-model">—</div>
            </div>
            <div class="sbd">
              <label>Model
                <select id="modelSelect"></select>
              </label>
            </div>
          </div>

          <div class="step">
            <div class="shd">
              <span class="pill" id="pill-color">2</span>
              <div style="flex:1">
                <div class="name">Color</div>
                <div class="meta" id="meta-color">Pick a frame color</div>
              </div>
              <div class="meta" id="price-color">—</div>
            </div>
            <div class="sbd">
              <label>Frame color
                <select id="colorSelect"></select>
              </label>
              <img id="colorPreview" class="option-preview" alt="Selected color preview" />
            </div>
          </div>

          <div class="step">
            <div class="shd">
              <span class="pill" id="pill-gearing">3</span>
              <div style="flex:1">
                <div class="name">Gearing</div>
                <div class="meta" id="meta-gearing">Select gearing</div>
              </div>
              <div class="meta" id="price-gearing">—</div>
            </div>
            <div class="sbd">
              <label>Gearing
                <select id="gearingSelect"></select>
              </label>
              <img id="gearingPreview" class="option-preview" alt="Selected gearing preview" />
            </div>
          </div>

          <div class="step">
            <div class="shd">
              <span class="pill" id="pill-rack">4</span>
              <div style="flex:1">
                <div class="name">Rack</div>
                <div class="meta" id="meta-rack">Choose a rack</div>
              </div>
              <div class="meta" id="price-rack">—</div>
            </div>
            <div class="sbd">
              <label>Rear rack
                <select id="rackSelect"></select>
              </label>
              <img id="rackPreview" class="option-preview" alt="Selected rack preview" />
            </div>
          </div>

          <div class="step">
            <div class="shd">
              <span class="pill" id="pill-lights">5</span>
              <div style="flex:1">
                <div class="name">Lights</div>
                <div class="meta" id="meta-lights">Add lights</div>
              </div>
              <div class="meta" id="price-lights">—</div>
            </div>
            <div class="sbd">
              <label>Lights
                <select id="lightsSelect"></select>
              </label>
              <img id="lightsPreview" class="option-preview" alt="Selected lights preview" />
            </div>
          </div>

          <div class="step">
            <div class="shd">
              <span class="pill ok">6</span>
              <div style="flex:1">
                <div class="name">Quantity</div>
                <div class="meta">How many bikes</div>
              </div>
              <div class="meta">—</div>
            </div>
            <div class="sbd">
              <label>Qty
                <input id="qtyInput" type="number" min="1" step="1" value="1" />
              </label>
              <label style="margin-top:10px;">Notes (optional)
                <textarea id="notesInput" rows="3" placeholder="Internal notes..."></textarea>
              </label>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel">
      <div class="hd">
        <div class="h2">Summary</div>
        <div class="badge" id="validBadge">
          <span class="dot bad" id="validDot"></span>
          <span id="validText">Incomplete</span>
        </div>
      </div>
      <div class="bd summary">
        <div class="totals">
          <div class="line"><span>Base price</span><strong id="basePrice">—</strong></div>
          <div class="line"><span>Options</span><strong id="optionsPrice">—</strong></div>
          <div class="hr"></div>
          <div class="line"><span>Unit total</span><strong id="unitTotal">—</strong></div>
          <div class="line"><span>Quantity</span><strong id="qtyDisplay">—</strong></div>
          <div class="hr"></div>
          <div class="line"><span>Grand total</span><strong id="grandTotal">—</strong></div>
        </div>

        <div class="items">
          <div class="line" style="margin-bottom:8px;">
            <strong>Selected</strong>
            <span class="muted">Product ID for cart: <b>114</b></span>
          </div>
          <ul id="selectionList"></ul>
          <div class="muted" id="constraintMsg" style="margin-top:10px; font-size:12px;"></div>
        </div>

        <div class="muted" style="font-size:12px; line-height:1.35">
          If “Order” fails with a message about missing option/variant, it means Product 114 needs a
          <b>variantId</b> or <b>optionSelections</b> to be added to cart.
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>
  <iframe name="hiddenCartFrame" style="display:none;"></iframe>

  <div class="admin-overlay" id="adminPrompt">
    <div class="admin-modal">
      <h3>Admin access</h3>
      <label>Password
        <input id="adminPassword" type="password" placeholder="Enter password" />
      </label>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
        <button id="adminCancel">Cancel</button>
        <button id="adminSubmit" class="primary">Enter</button>
      </div>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel">
    <div class="admin-header">
      <div>
        <strong>Admin Panel</strong>
        <div class="status-line" id="adminStatusLine"></div>
        <div class="status-line" id="adminSizeLine"></div>
      </div>
      <div class="admin-actions">
        <button id="btnRefreshSheet">Refresh from Sheet</button>
        <button id="btnResetSheet">Reset to Sheet</button>
        <button id="btnResetDefaults">Reset to Defaults</button>
        <button id="btnSaveSheet" class="success">Save to Sheet</button>
        <button id="btnExitAdmin" class="danger">Logout / Exit Admin</button>
      </div>
    </div>
    <div class="admin-body">
      <label>Model to edit
        <select id="adminModelSelect"></select>
      </label>
      <div class="admin-tabs" id="adminTabs"></div>
      <div id="adminSections"></div>
    </div>
  </div>

<script>
(function(){
  // =========================
  // BIGCOMMERCE SETTINGS
  // =========================
  const PRODUCT_ID = 114;

  // Your storefront home page (redirect after add-to-cart success)
  const HOME_URL = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/";

  // =========================
  // CONFIG API SETTINGS
  // =========================
  const CONFIG_API_BASE = "https://script.google.com/macros/s/AKfycbxXozAWB_L2XQhUEVOWd36XPdtqxhHPQbVHbcTzZvcznn6MS9igoZhigt6KBkTvG-0-Qg/exec";
  const CONFIG_API_KEY = "IwillUpdatethepaswordlater";
  const CONFIG_SIZE_WARNING = 200000;

  // =========================
  // DEFAULT CONFIG (fallback)
  // =========================
  const DEFAULT_CONFIG = {
    version: 1,
    models: {
      "c-line": {
        label: "C Line",
        options: {
          colors: [
            { id: "black", label: "Black", price: 0, imageUrl: "", enabled: true },
            { id: "red", label: "Red", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "1", label: "1-speed", price: 0, imageUrl: "", enabled: true },
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true },
            { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true },
            { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true }
          ]
        }
      },
      "c-line-elec": {
        label: "C Line Electric",
        options: {
          colors: [
            { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true },
            { id: "green", label: "Green", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
          ]
        }
      },
      "p-line": {
        label: "P Line",
        options: {
          colors: [
            { id: "yellow", label: "Yellow", price: 0, imageUrl: "", enabled: true },
            { id: "raw-lacquer", label: "Raw Lacquer", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "2", label: "2-speed", price: 0, imageUrl: "", enabled: true },
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "8", label: "8-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true },
            { id: "dynamo", label: "Dynamo lighting", price: 0, imageUrl: "", enabled: true }
          ]
        }
      },
      "p-line-elec": {
        label: "P Line Electric",
        options: {
          colors: [
            { id: "blue-elec", label: "Blue Electric", price: 0, imageUrl: "", enabled: true },
            { id: "line-green", label: "Line Green", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
          ]
        }
      },
      "g-line": {
        label: "G Line",
        options: {
          colors: [
            { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true },
            { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true },
            { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "no", label: "No rack", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery", label: "Battery lights", price: 0, imageUrl: "", enabled: true }
          ]
        }
      },
      "g-line-elec": {
        label: "G Line Electric",
        options: {
          colors: [
            { id: "orange", label: "Orange", price: 0, imageUrl: "", enabled: true },
            { id: "sand", label: "Sand", price: 0, imageUrl: "", enabled: true },
            { id: "champagne", label: "Champagne", price: 0, imageUrl: "", enabled: true }
          ],
          gearing: [
            { id: "4", label: "4-speed", price: 0, imageUrl: "", enabled: true },
            { id: "12", label: "12-speed", price: 0, imageUrl: "", enabled: true }
          ],
          rack: [
            { id: "yes", label: "Rack included", price: 0, imageUrl: "", enabled: true }
          ],
          lights: [
            { id: "battery-elec", label: "Battery lights (Electric)", price: 0, imageUrl: "", enabled: true }
          ]
        }
      }
    }
  };

  let CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

  // =========================
  // STATE
  // =========================
  const STORAGE_KEY = "bike_configurator_b2b_v3";
  const ADMIN_STORAGE_KEY = "bike_configurator_admin_mode";
  const state = {
    modelId: "",
    colorId: "",
    gearingId: "",
    rackId: "",
    lightsId: "",
    qty: 1,
    notes: ""
  };

  const adminState = {
    enabled: false,
    modelId: "",
    activeGroup: "colors",
    lastSheetUpdatedAt: "",
    lastSaveAttempt: ""
  };

  const ADMIN_PASSWORD = "Brompton";

  // =========================
  // DOM
  // =========================
  const $ = (id) => document.getElementById(id);
  const els = {
    model: $("modelSelect"),
    color: $("colorSelect"),
    gearing: $("gearingSelect"),
    rack: $("rackSelect"),
    lights: $("lightsSelect"),
    qty: $("qtyInput"),
    notes: $("notesInput"),

    basePrice: $("basePrice"),
    optionsPrice: $("optionsPrice"),
    unitTotal: $("unitTotal"),
    qtyDisplay: $("qtyDisplay"),
    grandTotal: $("grandTotal"),

    selectionList: $("selectionList"),
    constraintMsg: $("constraintMsg"),

    validDot: $("validDot"),
    validText: $("validText"),

    pillModel: $("pill-model"),
    pillColor: $("pill-color"),
    pillGearing: $("pill-gearing"),
    pillRack: $("pill-rack"),
    pillLights: $("pill-lights"),

    metaModel: $("meta-model"),
    metaColor: $("meta-color"),
    metaGearing: $("meta-gearing"),
    metaRack: $("meta-rack"),
    metaLights: $("meta-lights"),

    priceModel: $("price-model"),
    priceColor: $("price-color"),
    priceGearing: $("price-gearing"),
    priceRack: $("price-rack"),
    priceLights: $("price-lights"),

    btnReset: $("btnReset"),
    btnCopyJson: $("btnCopyJson"),
    btnOrder: $("btnOrder"),
    btnAdmin: $("btnAdmin"),

    toast: $("toast"),

    colorPreview: $("colorPreview"),
    gearingPreview: $("gearingPreview"),
    rackPreview: $("rackPreview"),
    lightsPreview: $("lightsPreview"),

    adminPrompt: $("adminPrompt"),
    adminPassword: $("adminPassword"),
    adminCancel: $("adminCancel"),
    adminSubmit: $("adminSubmit"),

    adminPanel: $("adminPanel"),
    adminModelSelect: $("adminModelSelect"),
    adminTabs: $("adminTabs"),
    adminSections: $("adminSections"),
    adminStatusLine: $("adminStatusLine"),
    adminSizeLine: $("adminSizeLine"),
    btnRefreshSheet: $("btnRefreshSheet"),
    btnResetSheet: $("btnResetSheet"),
    btnResetDefaults: $("btnResetDefaults"),
    btnSaveSheet: $("btnSaveSheet"),
    btnExitAdmin: $("btnExitAdmin")
  };

  // =========================
  // HELPERS
  // =========================
  const ROUTE_MODEL_MAP = {
    "/c-line-configurator": "c-line",
    "/c-line-elec-configurator": "c-line-elec",
    "/g-line-configurator": "g-line",
    "/g-line-elec-configurator": "g-line-elec",
    "/p-line-configurator": "p-line",
    "/p-line-elec-configurator": "p-line-elec"
  };

  const GROUPS = [
    { key: "colors", label: "Colors" },
    { key: "gearing", label: "Gearing" },
    { key: "rack", label: "Rack" },
    { key: "lights", label: "Lights" }
  ];

  function getForcedModelFromPath(){
    const rawPath = (window.location.pathname || "").toLowerCase();
    const cleaned = rawPath.replace(/\/+$/, "") || "/";
    return ROUTE_MODEL_MAP[cleaned] || "";
  }

  let forcedModelId = getForcedModelFromPath();
  let routeError = forcedModelId
    ? ""
    : "This page URL does not match a valid configurator route. Please use a supported model URL.";

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> els.toast.style.display="none", 2600);
  }

  function money(n){
    const cur = "EUR";
    try{
      return new Intl.NumberFormat(undefined, { style:"currency", currency:cur, maximumFractionDigits:0 }).format(n);
    }catch(e){
      return cur + " " + Math.round(n);
    }
  }

  function normalizeQty(v){
    const n = Number(v);
    if (!Number.isFinite(n) || n < 1) return 1;
    return Math.floor(n);
  }

  function setSelectOptions(selectEl, list, placeholder){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    list.forEach(item=>{
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
      selectEl.appendChild(opt);
    });
  }

  function setSingleOption(selectEl, item){
    selectEl.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = item.id;
    opt.textContent = item.label + (item.price ? ` (+${money(item.price)})` : "");
    selectEl.appendChild(opt);
  }

  function updatePill(pillEl, ok){
    pillEl.classList.toggle("ok", !!ok);
  }

  function metaWithFixed(label, fallback, selectEl){
    if (!label) return fallback;
    if (selectEl && selectEl.dataset.fixed === "true"){
      return `${label} (fixed for this model)`;
    }
    return label;
  }

  function getModel(modelId){
    return (CONFIG.models && CONFIG.models[modelId]) || null;
  }

  function getEnabledOptions(model, groupKey){
    if (!model || !model.options || !model.options[groupKey]) return [];
    return model.options[groupKey].filter(opt => opt.enabled);
  }

  function applyOptions(selectEl, options, placeholder, currentValue){
    if (!options.length){
      setSelectOptions(selectEl, [], "Unavailable");
      selectEl.disabled = true;
      selectEl.dataset.fixed = "true";
      return { value: "", fixed: true, option: null };
    }
    setSelectOptions(selectEl, options, placeholder);
    const isFixed = options.length === 1;
    let nextValue = currentValue || "";
    if (isFixed){
      nextValue = options[0].id;
    } else if (nextValue && !options.some(opt => opt.id === nextValue)){
      nextValue = "";
    }
    selectEl.disabled = isFixed;
    selectEl.dataset.fixed = isFixed ? "true" : "false";
    return { value: nextValue, fixed: isFixed, option: options[0] || null };
  }

  function updatePreview(imgEl, option){
    if (option && option.imageUrl){
      imgEl.src = option.imageUrl;
      imgEl.style.display = "block";
    }else{
      imgEl.removeAttribute("src");
      imgEl.style.display = "none";
    }
  }

  function validateAndApplyConstraints(){
    if (routeError){
      state.modelId = "";
      state.colorId = "";
      state.gearingId = "";
      state.rackId = "";
      state.lightsId = "";
      setSelectOptions(els.model, [], "Invalid route");
      setSelectOptions(els.color, [], "Unavailable");
      setSelectOptions(els.gearing, [], "Unavailable");
      setSelectOptions(els.rack, [], "Unavailable");
      setSelectOptions(els.lights, [], "Unavailable");
      els.model.disabled = true;
      els.color.disabled = true;
      els.gearing.disabled = true;
      els.rack.disabled = true;
      els.lights.disabled = true;
      return { ok:false, msg:routeError, model:null, routeError:true };
    }

    const model = getModel(forcedModelId);
    if (!model){
      return { ok:false, msg:"Unsupported model route. Please use a valid configurator URL.", model:null, routeError:true };
    }

    state.modelId = forcedModelId;
    setSingleOption(els.model, { id: forcedModelId, label: model.label, price: 0 });
    els.model.value = forcedModelId;
    els.model.disabled = true;
    els.model.dataset.fixed = "true";

    const colorResult = applyOptions(els.color, getEnabledOptions(model, "colors"), "Select color…", state.colorId);
    state.colorId = colorResult.value;
    const gearingResult = applyOptions(els.gearing, getEnabledOptions(model, "gearing"), "Select gearing…", state.gearingId);
    state.gearingId = gearingResult.value;
    const rackResult = applyOptions(els.rack, getEnabledOptions(model, "rack"), "Select rack…", state.rackId);
    state.rackId = rackResult.value;
    const lightsResult = applyOptions(els.lights, getEnabledOptions(model, "lights"), "Select lights…", state.lightsId);
    state.lightsId = lightsResult.value;

    els.color.value = state.colorId;
    els.gearing.value = state.gearingId;
    els.rack.value = state.rackId;
    els.lights.value = state.lightsId;

    const missing = [];
    if (!state.modelId) missing.push("Model");
    if (!state.colorId) missing.push("Color");
    if (!state.gearingId) missing.push("Gearing");
    if (!state.rackId) missing.push("Rack");
    if (!state.lightsId) missing.push("Lights");

    if (missing.length){
      return { ok:false, msg:"Missing: " + missing.join(", ") + ".", model };
    }
    return { ok:true, msg:"Ready to order.", model };
  }

  function buildAttribute116Value(){
    const model = getModel(state.modelId);
    const selections = [
      { label: "Model", value: model ? model.label : "" },
      { label: "Colour", value: findOptionLabel(model, "colors", state.colorId) },
      { label: "Speed", value: findOptionLabel(model, "gearing", state.gearingId) },
      { label: "Rack", value: findOptionLabel(model, "rack", state.rackId) },
      { label: "Light", value: findOptionLabel(model, "lights", state.lightsId) }
    ];

    const missing = [];
    const parts = selections.map(({ label, value }) => {
      if (!value){
        missing.push(label);
        return "";
      }
      return `${label}: ${value}`;
    });

    if (missing.length){
      return { missing, value: "" };
    }
    const qtyValue = normalizeQty(state.qty);
    const notesValue = (state.notes || "").trim();
    parts.push(`Qty: ${qtyValue}`);
    parts.push(`Notes: ${notesValue || "(none)"}`);
    return { missing, value: parts.join("\n") };
  }

  function findOption(model, groupKey, id){
    if (!model || !model.options || !model.options[groupKey]) return null;
    return model.options[groupKey].find(opt => opt.id === id) || null;
  }

  function findOptionLabel(model, groupKey, id){
    const option = findOption(model, groupKey, id);
    return option ? option.label : "";
  }

  function calc(){
    const model = getModel(state.modelId);
    const color = findOption(model, "colors", state.colorId);
    const gearing = findOption(model, "gearing", state.gearingId);
    const rack = findOption(model, "rack", state.rackId);
    const lights = findOption(model, "lights", state.lightsId);

    const base = 0;
    const options =
      (color ? color.price : 0) +
      (gearing ? gearing.price : 0) +
      (rack ? rack.price : 0) +
      (lights ? lights.price : 0);

    const unit = base + options;
    const qty = normalizeQty(state.qty);
    const total = unit * qty;

    return { base, options, unit, qty, total, model, color, gearing, rack, lights };
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj) return;
      state.modelId = obj.modelId || "";
      state.colorId = obj.colorId || "";
      state.gearingId = obj.gearingId || "";
      state.rackId = obj.rackId || "";
      state.lightsId = obj.lightsId || "";
      state.qty = normalizeQty(obj.qty || 1);
      state.notes = obj.notes || "";
      if (forcedModelId){
        if (state.modelId !== forcedModelId){
          state.colorId = "";
          state.gearingId = "";
          state.rackId = "";
          state.lightsId = "";
        }
        state.modelId = forcedModelId;
      }else{
        state.modelId = "";
        state.colorId = "";
        state.gearingId = "";
        state.rackId = "";
        state.lightsId = "";
      }
    }catch(e){}
  }

  function loadAdminState(){
    try{
      const raw = localStorage.getItem(ADMIN_STORAGE_KEY);
      adminState.enabled = raw === "true";
    }catch(e){
      adminState.enabled = false;
    }
  }

  function saveAdminState(){
    try{
      localStorage.setItem(ADMIN_STORAGE_KEY, adminState.enabled ? "true" : "false");
    }catch(e){}
  }

  function exportConfig(){
    return JSON.stringify(CONFIG, null, 2);
  }

  function getConfigSize(){
    try{
      return JSON.stringify(CONFIG).length;
    }catch(e){
      return 0;
    }
  }

  function updateAdminStatus(){
    const updatedAt = adminState.lastSheetUpdatedAt ? `Sheet updated: ${adminState.lastSheetUpdatedAt}` : "Sheet updated: —";
    const lastSave = adminState.lastSaveAttempt ? `Last save attempt: ${adminState.lastSaveAttempt}` : "Last save attempt: —";
    els.adminStatusLine.textContent = `${updatedAt} | ${lastSave}`;
    const size = getConfigSize();
    const warning = size > CONFIG_SIZE_WARNING;
    els.adminSizeLine.textContent = `Config size: ${size} chars${warning ? " (warning: large config)" : ""}`;
    els.adminSizeLine.classList.toggle("warn", warning);
  }

  function reconcileSelections(){
    let changed = false;
    const model = getModel(forcedModelId);
    if (!model){
      if (state.modelId || state.colorId || state.gearingId || state.rackId || state.lightsId){
        changed = true;
      }
      state.modelId = "";
      state.colorId = "";
      state.gearingId = "";
      state.rackId = "";
      state.lightsId = "";
    }else{
      state.modelId = forcedModelId;
      const groups = [
        { key: "colors", field: "colorId" },
        { key: "gearing", field: "gearingId" },
        { key: "rack", field: "rackId" },
        { key: "lights", field: "lightsId" }
      ];
      groups.forEach(({ key, field }) => {
        const enabledOptions = getEnabledOptions(model, key);
        const isAvailable = enabledOptions.some(opt => opt.id === state[field]);
        if (!isAvailable){
          if (state[field]) changed = true;
          state[field] = "";
        }
      });
    }
    if (changed){
      saveState();
    }
  }

  async function fetchConfigFromSheet(){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    let responseText = "";
    const res = await fetch(url, {
      method: "GET",
      cache: "no-store",
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Config response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true || !json.data){
      const message = json && json.error ? json.error : "Config response missing ok/data.";
      const apiError = new Error(message);
      apiError.responseText = responseText;
      throw apiError;
    }
    adminState.lastSheetUpdatedAt = json.meta && json.meta.updated_at ? json.meta.updated_at : "";
    updateAdminStatus();
    return json.data;
  }

  async function saveConfigToSheet(configObj){
    const url = `${CONFIG_API_BASE}?key=${encodeURIComponent(CONFIG_API_KEY)}`;
    const body = new URLSearchParams();
    body.set("payload", JSON.stringify(configObj));
    body.set("key", CONFIG_API_KEY);
    let responseText = "";
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString(),
      credentials: "omit"
    });
    responseText = await res.text();
    let json;
    try{
      json = JSON.parse(responseText);
    }catch(err){
      const parseError = new Error("Save response is not valid JSON.");
      parseError.responseText = responseText;
      throw parseError;
    }
    if (!json || json.ok !== true){
      const message = json && json.error ? json.error : responseText;
      const apiError = new Error(message || "Save failed.");
      apiError.responseText = responseText;
      throw apiError;
    }
    return json;
  }

  async function loadConfigFromSheet(useFallbackOnError){
    try{
      CONFIG = await fetchConfigFromSheet();
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config loaded from sheet.");
      return true;
    }catch(err){
      console.error("Failed to load config from sheet.", err, err && err.responseText ? err.responseText : "");
      if (useFallbackOnError){
        CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        reconcileSelections();
        renderBuyer();
        renderAdmin();
        toast("Using local defaults (config API unavailable)");
      }else{
        const message = err && err.message ? err.message : "Unknown error";
        toast(`Failed to load sheet config: ${message}`);
      }
      return false;
    }
  }

  async function saveConfigFlow(){
    const errors = validateConfig(CONFIG);
    if (errors.length){
      toast("Fix validation errors before saving:\n" + errors.join("\n"));
      return false;
    }
    adminState.lastSaveAttempt = new Date().toLocaleString();
    updateAdminStatus();
    try{
      await saveConfigToSheet(CONFIG);
      toast("Saved to Sheet");
      renderBuyer();
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to save config to sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to save to Sheet: ${message}`);
      return false;
    }
  }

  function validateConfig(config){
    const errors = [];
    if (!config || !config.models){
      errors.push("Config models missing.");
      return errors;
    }
    Object.entries(config.models).forEach(([modelId, model]) => {
      GROUPS.forEach(group => {
        const options = model.options && model.options[group.key] ? model.options[group.key] : [];
        const seen = new Set();
        options.forEach((opt, index) => {
          if (!opt.id){
            errors.push(`${modelId} ${group.label} option #${index + 1}: id is required.`);
          }else if (seen.has(opt.id)){
            errors.push(`${modelId} ${group.label} option id "${opt.id}" is duplicated.`);
          }else{
            seen.add(opt.id);
          }
          if (opt.imageUrl && !/^https?:\/\//i.test(opt.imageUrl)){
            errors.push(`${modelId} ${group.label} option "${opt.id}": imageUrl must start with http:// or https://`);
          }
          const price = Number(opt.price);
          if (!Number.isFinite(price) || price < 0){
            errors.push(`${modelId} ${group.label} option "${opt.id}": price must be a number >= 0`);
          }
        });
      });
    });
    return errors;
  }

  function renderBuyer(){
    const v = validateAndApplyConstraints();
    const c = calc();

    els.constraintMsg.textContent = v.msg || "";

    els.basePrice.textContent = c.model ? money(c.base) : "—";
    els.optionsPrice.textContent = c.model ? money(c.options) : "—";
    els.unitTotal.textContent = c.model ? money(c.unit) : "—";
    els.qtyDisplay.textContent = String(c.qty);
    els.grandTotal.textContent = c.model ? money(c.total) : "—";

    if (v.ok){
      els.validDot.className = "dot ok";
      els.validText.textContent = "Ready";
    }else{
      els.validDot.className = "dot bad";
      els.validText.textContent = "Incomplete";
    }
    els.btnOrder.disabled = !v.ok;

    els.metaModel.textContent = metaWithFixed(c.model ? c.model.label : "", "Choose a base model", els.model);
    els.priceModel.textContent = c.model ? money(0) : "—";
    els.metaColor.textContent = metaWithFixed(c.color ? c.color.label : "", "Pick a frame color", els.color);
    els.priceColor.textContent = c.color ? (c.color.price ? "+"+money(c.color.price) : money(0)) : "—";
    els.metaGearing.textContent = metaWithFixed(c.gearing ? c.gearing.label : "", "Select gearing", els.gearing);
    els.priceGearing.textContent = c.gearing ? (c.gearing.price ? "+"+money(c.gearing.price) : money(0)) : "—";
    els.metaRack.textContent = metaWithFixed(c.rack ? c.rack.label : "", "Choose a rack", els.rack);
    els.priceRack.textContent = c.rack ? (c.rack.price ? "+"+money(c.rack.price) : money(0)) : "—";
    els.metaLights.textContent = metaWithFixed(c.lights ? c.lights.label : "", "Add lights", els.lights);
    els.priceLights.textContent = c.lights ? (c.lights.price ? "+"+money(c.lights.price) : money(0)) : "—";

    updatePill(els.pillModel, !!state.modelId);
    updatePill(els.pillColor, !!state.colorId);
    updatePill(els.pillGearing, !!state.gearingId);
    updatePill(els.pillRack, !!state.rackId);
    updatePill(els.pillLights, !!state.lightsId);

    els.selectionList.innerHTML = "";
    const addLi = (label, val) => {
      const li = document.createElement("li");
      li.innerHTML = `<span class="muted">${label}:</span> ${val}`;
      els.selectionList.appendChild(li);
    };
    if (c.model) addLi("Model", c.model.label);
    if (c.color) addLi("Color", c.color.label);
    if (c.gearing) addLi("Gearing", c.gearing.label);
    if (c.rack) addLi("Rack", c.rack.label);
    if (c.lights) addLi("Lights", c.lights.label);
    addLi("Qty", String(c.qty));
    if (state.notes && state.notes.trim()) addLi("Notes", state.notes.trim());

    updatePreview(els.colorPreview, c.color);
    updatePreview(els.gearingPreview, c.gearing);
    updatePreview(els.rackPreview, c.rack);
    updatePreview(els.lightsPreview, c.lights);

    saveState();
  }

  function renderAdmin(){
    if (!adminState.enabled){
      els.adminPanel.style.display = "none";
      return;
    }
    const modelIds = Object.keys(CONFIG.models || {});
    if (!adminState.modelId || !CONFIG.models[adminState.modelId]){
      adminState.modelId = modelIds[0] || "";
    }
    els.adminPanel.style.display = "flex";

    els.adminModelSelect.innerHTML = "";
    modelIds.forEach(id => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = CONFIG.models[id].label || id;
      els.adminModelSelect.appendChild(opt);
    });
    els.adminModelSelect.value = adminState.modelId;

    els.adminTabs.innerHTML = "";
    GROUPS.forEach(group => {
      const btn = document.createElement("button");
      btn.textContent = group.label;
      btn.dataset.group = group.key;
      if (adminState.activeGroup === group.key){
        btn.classList.add("active");
      }
      els.adminTabs.appendChild(btn);
    });

    const model = CONFIG.models[adminState.modelId];
    els.adminSections.innerHTML = "";

    GROUPS.forEach(group => {
      const options = model.options[group.key] || [];
      const section = document.createElement("div");
      section.className = "admin-section";
      section.style.display = adminState.activeGroup === group.key ? "block" : "none";
      section.dataset.group = group.key;
      section.innerHTML = `
        <div class="line" style="margin-bottom:8px;">
          <strong>${group.label}</strong>
          <button class="primary" data-action="add-option" data-group="${group.key}">Add option</button>
        </div>
        <table class="admin-table">
          <thead>
            <tr>
              <th style="width:120px;">ID</th>
              <th>Label</th>
              <th style="width:90px;">Price</th>
              <th>Image URL</th>
              <th style="width:80px;">Enabled</th>
              <th style="width:160px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${options.map((opt, index) => `
              <tr data-index="${index}" data-group="${group.key}">
                <td><input type="text" value="${escapeHtml(opt.id)}" data-field="id"></td>
                <td><input type="text" value="${escapeHtml(opt.label)}" data-field="label"></td>
                <td><input type="number" min="0" step="1" value="${Number.isFinite(opt.price) ? opt.price : 0}" data-field="price"></td>
                <td><input type="text" value="${escapeHtml(opt.imageUrl || "")}" data-field="imageUrl"></td>
                <td style="text-align:center;"><input type="checkbox" ${opt.enabled ? "checked" : ""} data-field="enabled"></td>
                <td>
                  <div class="admin-row-actions">
                    <button data-action="move-up">Up</button>
                    <button data-action="move-down">Down</button>
                    <button data-action="delete" class="danger">Delete</button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      els.adminSections.appendChild(section);
    });
    updateAdminStatus();
  }

  function escapeHtml(str){
    return String(str || "").replace(/[&<>"]+/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;"
    }[m] || m));
  }

  // =========================
  // BIGCOMMERCE CART HELPERS
  // =========================
  function submitCartForm(qty, attribute116Value){
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://store-tiznycmyx9-1826150.catalyst-sandbox-vercel.store/cart.php";
    form.target = "hiddenCartFrame";

    const addInput = (name, value) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = value;
      form.appendChild(input);
    };

    addInput("action", "add");
    addInput("product_id", String(PRODUCT_ID));
    addInput("qty[]", String(qty));
    addInput("attribute[116]", attribute116Value);

    document.body.appendChild(form);
    form.submit();
    form.remove();
  }

  // =========================
  // ADMIN HELPERS
  // =========================
  function openAdminPrompt(){
    els.adminPrompt.style.display = "flex";
    els.adminPassword.value = "";
    els.adminPassword.focus();
  }

  function closeAdminPrompt(){
    els.adminPrompt.style.display = "none";
  }

  function enableAdminMode(){
    adminState.enabled = true;
    saveAdminState();
    toast("Admin mode enabled");
    renderAdmin();
  }

  function disableAdminMode(){
    adminState.enabled = false;
    saveAdminState();
    els.adminPanel.style.display = "none";
    toast("Admin mode disabled");
  }

  // =========================
  // EVENTS
  // =========================
  function initSelects(){
    if (forcedModelId){
      const model = getModel(forcedModelId);
      if (model){
        setSingleOption(els.model, { id: forcedModelId, label: model.label, price: 0 });
        els.model.value = forcedModelId;
      }else{
        setSelectOptions(els.model, [], "Invalid route");
      }
    }else{
      setSelectOptions(els.model, [], "Invalid route");
    }
    setSelectOptions(els.color, [], "Select color…");
    setSelectOptions(els.gearing, [], "Select gearing…");
    setSelectOptions(els.rack, [], "Select rack…");
    setSelectOptions(els.lights, [], "Select lights…");
  }

  els.model.addEventListener("change", (e)=>{ state.modelId = e.target.value; renderBuyer(); });
  els.color.addEventListener("change", (e)=>{ state.colorId = e.target.value; renderBuyer(); });
  els.gearing.addEventListener("change", (e)=>{ state.gearingId = e.target.value; renderBuyer(); });
  els.rack.addEventListener("change", (e)=>{ state.rackId = e.target.value; renderBuyer(); });
  els.lights.addEventListener("change", (e)=>{ state.lightsId = e.target.value; renderBuyer(); });
  els.qty.addEventListener("input", (e)=>{ state.qty = normalizeQty(e.target.value); renderBuyer(); });
  els.notes.addEventListener("input", (e)=>{ state.notes = e.target.value || ""; renderBuyer(); });

  els.btnReset.addEventListener("click", ()=>{
    state.modelId = "";
    state.colorId = "";
    state.gearingId = "";
    state.rackId = "";
    state.lightsId = "";
    state.qty = 1;
    state.notes = "";
    els.qty.value = "1";
    els.notes.value = "";
    initSelects();
    renderBuyer();
    toast("Reset complete.");
  });

  els.btnCopyJson.addEventListener("click", async ()=>{
    const txt = exportConfig();
    try{
      await navigator.clipboard.writeText(txt);
      toast("Config JSON copied.");
    }catch(e){
      prompt("Copy JSON:", txt);
    }
  });

  els.btnOrder.addEventListener("click", ()=>{
    const attributeResult = buildAttribute116Value();
    if (attributeResult.missing.length){
      const message = `Please complete: ${attributeResult.missing.join(", ")}`;
      toast("Complete required selections before ordering.");
      alert(message);
      return;
    }

    const qty = normalizeQty(state.qty);

    els.btnOrder.disabled = true;
    els.btnOrder.textContent = "Ordering…";

    submitCartForm(qty, attributeResult.value);
    toast("Added to cart. Returning home…");
    setTimeout(() => {
      window.location.href = HOME_URL;
    }, 700);
  });

  els.btnAdmin.addEventListener("click", ()=>{
    if (adminState.enabled){
      renderAdmin();
      return;
    }
    openAdminPrompt();
  });

  els.adminCancel.addEventListener("click", ()=>{
    closeAdminPrompt();
  });

  els.adminSubmit.addEventListener("click", ()=>{
    const value = els.adminPassword.value || "";
    if (value === ADMIN_PASSWORD){
      closeAdminPrompt();
      enableAdminMode();
    }else{
      toast("Wrong password");
    }
  });

  els.adminPassword.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){
      els.adminSubmit.click();
    }
  });

  els.btnExitAdmin.addEventListener("click", ()=>{
    disableAdminMode();
  });

  async function refreshConfigFromSheet(){
    try{
      CONFIG = await fetchConfigFromSheet();
      reconcileSelections();
      renderBuyer();
      renderAdmin();
      toast("Config refreshed from sheet.");
      return true;
    }catch(err){
      const message = err && err.message ? err.message : "Unknown error";
      console.error("Failed to refresh config from sheet.", err, err && err.responseText ? err.responseText : "");
      toast(`Failed to refresh from Sheet: ${message}`);
      return false;
    }
  }

  els.btnRefreshSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetSheet.addEventListener("click", ()=>{
    refreshConfigFromSheet();
  });

  els.btnResetDefaults.addEventListener("click", ()=>{
    CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
    reconcileSelections();
    renderBuyer();
    renderAdmin();
    toast("Reset to local defaults.");
  });

  els.btnSaveSheet.addEventListener("click", ()=>{
    saveConfigFlow();
  });

  els.adminModelSelect.addEventListener("change", (e)=>{
    adminState.modelId = e.target.value;
    renderAdmin();
  });

  els.adminTabs.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    adminState.activeGroup = btn.dataset.group || adminState.activeGroup;
    renderAdmin();
  });

  els.adminSections.addEventListener("click", (e)=>{
    const actionBtn = e.target.closest("button");
    if (!actionBtn) return;
    const action = actionBtn.dataset.action;
    const group = actionBtn.dataset.group || actionBtn.closest("tr")?.dataset.group;
    if (!group) return;
    const model = CONFIG.models[adminState.modelId];
    const options = model.options[group];
    if (action === "add-option"){
      options.push({
        id: `new-${Date.now()}`,
        label: "",
        price: 0,
        imageUrl: "",
        enabled: true
      });
      renderAdmin();
      return;
    }
    const row = actionBtn.closest("tr");
    const index = row ? Number(row.dataset.index) : -1;
    if (index < 0) return;
    if (action === "delete"){
      options.splice(index, 1);
    }
    if (action === "move-up" && index > 0){
      [options[index - 1], options[index]] = [options[index], options[index - 1]];
    }
    if (action === "move-down" && index < options.length - 1){
      [options[index + 1], options[index]] = [options[index], options[index + 1]];
    }
    renderAdmin();
  });

  els.adminSections.addEventListener("input", (e)=>{
    const input = e.target;
    const row = input.closest("tr");
    if (!row) return;
    const group = row.dataset.group;
    const index = Number(row.dataset.index);
    const field = input.dataset.field;
    const model = CONFIG.models[adminState.modelId];
    if (!model || !model.options[group] || !model.options[group][index]) return;
    const option = model.options[group][index];
    if (field === "enabled"){
      option.enabled = input.checked;
    }else if (field === "price"){
      option.price = Number(input.value);
    }else if (field === "id"){
      option.id = input.value.trim();
    }else if (field === "label"){
      option.label = input.value;
    }else if (field === "imageUrl"){
      option.imageUrl = input.value.trim();
    }
    updateAdminStatus();
  });

  // =========================
  // INIT
  // =========================
  loadState();
  loadAdminState();
  initSelects();
  els.qty.value = String(state.qty);
  els.notes.value = state.notes || "";
  renderBuyer();
  if (routeError){
    toast(routeError);
  }
  if (adminState.enabled){
    renderAdmin();
  }
  loadConfigFromSheet(true);
})();
</script>
</body>
</html>
